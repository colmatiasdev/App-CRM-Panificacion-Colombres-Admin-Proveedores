<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Costo de Elaboración del Producto - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../costos/costos.css">
    <script src="../../Arquitectura/config.js"></script>
    <script src="../../Arquitectura/config-sheets.js"></script>
    <script src="../../Arquitectura/sheets/producto-unitario-base/producto-unitario-base-sheets-base.js"></script>
    <script src="../../Arquitectura/sheets/producto-unitario-base/sheets-editar-producto-unitario-base.config.js"></script>
    <script src="../armador-receta-hub.config.js"></script>
    <script>window.PRODUCTO_UNITARIO_BASE_ACCION_ACTUAL = "editar"; window.ARMADOR_RECETA_SUBMODULO_ACTUAL = "producto-unitario-base";</script>
</head>
<body class="costos-page">
    <nav class="costos-nav" id="armador-receta-nav" aria-label="Navegación principal"></nav>
    <main class="costos-main">
        <h1 class="costos-title costos-title--con-icono"><i class="fa-solid fa-pen costos-title-icono" aria-hidden="true"></i> Costo de Elaboración del Producto</h1>
        <p class="costos-intro">Modificá los datos y guardá los cambios.</p>
        <div id="edit-form-container" class="costos-datos">
            <div id="costos-edit-alert" class="costos-alert" role="alert" aria-live="polite" style="display:none;"></div>
            <p id="edit-no-data" class="costos-placeholder" style="display:none;">No hay datos del registro. Volvé al listado y usá «Editar» en una tarjeta.</p>
            <p id="edit-loading" class="costos-placeholder">Cargando…</p>
            <form id="costos-edit-form" class="costos-edit-form" style="display:none;">
                <div id="edit-fields"></div>
                <div class="costos-edit-actions">
                    <button type="submit" class="costos-edit-btn-save" id="costos-edit-btn-save"><i class="fa-solid fa-check" aria-hidden="true"></i> Guardar cambios</button>
                </div>
            </form>
            <section id="elaboracion-vinculada-section" class="costos-edit-seccion costos-tabla-elaboracion-vinculada" style="display:none;" aria-label="Contenido de productos elaborados">
                <h2 class="costos-edit-seccion-titulo">Contenido de productos elaborados</h2>
                <p id="elaboracion-vinculada-sin-id" class="costos-placeholder" style="display:none;">No hay elaboración vinculada a este producto.</p>
                <div id="elaboracion-vinculada-loading" class="costos-placeholder" style="display:none;">Cargando elaboración…</div>
                <div id="elaboracion-vinculada-table-wrap" style="display:none;">
                    <table id="elaboracion-vinculada-table" class="costos-tabla costos-tabla--vinculada" role="table">
                        <caption class="costos-sr-only">Datos de la elaboración producto base vinculada por IDElaboracion-ProductoBase</caption>
                        <thead id="elaboracion-vinculada-thead"></thead>
                        <tbody id="elaboracion-vinculada-tbody"></tbody>
                    </table>
                </div>
            </section>
            <div class="costos-edit-actions costos-edit-actions--final">
                <button type="button" class="costos-edit-btn costos-edit-btn-relleno" id="btn-agregar-relleno" aria-label="Agregar Relleno">Agregar Relleno</button>
                <button type="button" class="costos-edit-btn costos-edit-btn-decoracion" id="btn-agregar-decoracion" aria-label="Agregar Decoración">Agregar Decoración</button>
            </div>
        </div>
    </main>
    <script src="../armador-receta-nav.js"></script>
    <script src="../../Arquitectura/sheets/producto-unitario-base/producto-unitario-base-config.js"></script>
    <script>
        (function () {
            var STORAGE_EDIT = "costosEditRecordProductoUnitarioBase";
            var config = window.APP_CONFIG || {};
            var appsScriptUrl = (config.appsScriptUrl || "").trim();
            function norm(s) { return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, "").replace(/-/g, ""); }
            function mapRowToConfigOrder(rowFromStorage, headersFromStorage, columnas) {
                var configNombres = columnas.map(function (c) { return c.nombre; });
                var out = [];
                for (var i = 0; i < configNombres.length; i++) {
                    var nombre = configNombres[i];
                    var idx = -1;
                    for (var j = 0; j < headersFromStorage.length; j++) { if (norm(headersFromStorage[j]) === norm(nombre)) { idx = j; break; } }
                    out.push(idx >= 0 ? (rowFromStorage[idx] != null ? String(rowFromStorage[idx]) : "") : "");
                }
                return out;
            }
            var noDataEl = document.getElementById("edit-no-data");
            var loadingEl = document.getElementById("edit-loading");
            var formEl = document.getElementById("costos-edit-form");
            var fieldsContainer = document.getElementById("edit-fields");
            var alertEl = document.getElementById("costos-edit-alert");
            function showEditAlert(message, type) {
                if (!alertEl) return;
                alertEl.textContent = message;
                alertEl.className = "costos-alert costos-alert--" + (type === "success" ? "success" : "error") + " is-visible";
                alertEl.style.display = "block";
                alertEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
            function hideEditAlert() { if (alertEl) { alertEl.className = "costos-alert"; alertEl.style.display = "none"; alertEl.textContent = ""; } }
            var raw = sessionStorage.getItem(STORAGE_EDIT);
            if (!raw) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; formEl.style.display = "none"; } else {
                var loadConfig = window.PRODUCTO_UNITARIO_BASE_LOAD_CONFIG;
                if (!loadConfig) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "No se pudo cargar la configuración."; formEl.style.display = "none"; } else {
                    function ensureCombo(sheetConfig, url) {
                        var base = window.PRODUCTO_UNITARIO_BASE_SHEET_BASE;
                        var combosConfig = (sheetConfig && Array.isArray(sheetConfig.combos)) ? sheetConfig.combos : ((base && base.hoja && base.hoja.combos && Array.isArray(base.hoja.combos)) ? base.hoja.combos : []);
                        if (!url || !combosConfig.length) return Promise.resolve();
                        var sheetName = combosConfig[0].sheetCombo;
                        function findColIdx(headers, colNombre, alternativas) {
                            var idx = headers.indexOf(colNombre);
                            if (idx >= 0) return idx;
                            if (alternativas && alternativas.length) { for (var a = 0; a < alternativas.length; a++) { idx = headers.indexOf(alternativas[a]); if (idx >= 0) return idx; } }
                            var norm = function (s) { return String(s || "").trim().toLowerCase().replace(/[\s\-]/g, ""); };
                            var n = norm(colNombre);
                            for (var h = 0; h < headers.length; h++) { if (norm(headers[h]) === n) return h; }
                            return -1;
                        }
                        function getValFromRow(row, headers, idx, colNombre) {
                            if (Array.isArray(row)) return idx >= 0 && row[idx] != null ? row[idx] : null;
                            if (!row || typeof row !== "object") return null;
                            if (row[colNombre] != null && row[colNombre] !== "") return row[colNombre];
                            if (idx >= 0 && headers[idx] != null && row[headers[idx]] != null && row[headers[idx]] !== "") return row[headers[idx]];
                            var norm = function (s) { return String(s || "").trim().toLowerCase().replace(/[\s\-]/g, ""); };
                            var n = norm(colNombre);
                            for (var k in row) { if (Object.prototype.hasOwnProperty.call(row, k) && norm(k) === n) { var val = row[k]; if (val != null && val !== "") return val; } }
                            return null;
                        }
                        return fetch(url + "?action=list&sheet=" + encodeURIComponent(sheetName) + "&limit=5000&_=" + Date.now(), { cache: "no-store" }).then(function (res) { return res.json(); }).then(function (json) {
                            var apiHeaders = (json && json.data && json.data.headers) ? json.data.headers : [];
                            var rows = (json && json.data && json.data.rows) ? json.data.rows : [];
                            if (!window["COMPONENTE-COMBOS"]) window["COMPONENTE-COMBOS"] = {};
                            combosConfig.forEach(function (def) {
                                if (def.sheetCombo !== sheetName) return;
                                var idx = findColIdx(apiHeaders, def.columnaCombo, def.columnaComboAlternativas);
                                if (idx < 0 && def.columnaComboIndex >= 0 && def.columnaComboIndex < apiHeaders.length) idx = def.columnaComboIndex;
                                var colNombre = idx >= 0 ? apiHeaders[idx] : def.columnaCombo;
                                var unicos = [], set = {};
                                if (idx >= 0 || colNombre) { for (var r = 0; r < rows.length; r++) { var v = getValFromRow(rows[r], apiHeaders, idx, colNombre); var s = (v != null && String(v).trim() !== "") ? String(v).trim() : null; if (s && !set[s]) { set[s] = true; unicos.push(s); } } unicos.sort(); }
                                window["COMPONENTE-COMBOS"][def.claveCombo] = unicos.length ? unicos : [];
                            });
                        }).catch(function () { if (!window["COMPONENTE-COMBOS"]) window["COMPONENTE-COMBOS"] = {}; combosConfig.forEach(function (def) { if (!window["COMPONENTE-COMBOS"][def.claveCombo]) window["COMPONENTE-COMBOS"][def.claveCombo] = []; }); });
                    }
                    loadConfig().then(function (sheetConfig) { return ensureCombo(sheetConfig, appsScriptUrl).then(function () { return sheetConfig; }); }).then(function (sheetConfig) {
                        var data; try { data = JSON.parse(raw); } catch (e) { data = {}; }
                        var headersFromStorage = data.headers || [];
                        var rowFromStorage = data.row || [];
                        var id = data.id != null ? String(data.id) : "";
                        var nombreHoja = sheetConfig.nombreHoja;
                        var columnas = sheetConfig.columnas || [];
                        var headers = columnas.map(function (c) { return c.nombre; });
                        var row = mapRowToConfigOrder(rowFromStorage, headersFromStorage, columnas);
                        if (row.length !== headers.length) { row = headers.map(function (_, i) { return rowFromStorage[i] != null ? String(rowFromStorage[i]) : ""; }); }
                        loadingEl.style.display = "none"; noDataEl.style.display = "none"; formEl.style.display = "block"; fieldsContainer.innerHTML = "";
                        columnas.forEach(function (col, idx) {
                            var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                            if (!nombre) return;
                            var val = row[idx] != null ? String(row[idx]).trim() : "";
                            if (col.visible === false) {
                                var hiddenWrap = document.createElement("div");
                                hiddenWrap.className = "costos-edit-field costos-edit-field-hidden";
                                hiddenWrap.style.display = "none";
                                var hiddenInput = document.createElement("input");
                                hiddenInput.type = "hidden";
                                hiddenInput.id = "field-" + idx;
                                hiddenInput.setAttribute("data-header-index", String(idx));
                                hiddenInput.setAttribute("data-nombre", col.nombre || nombre);
                                hiddenInput.value = val;
                                hiddenWrap.appendChild(hiddenInput);
                                fieldsContainer.appendChild(hiddenWrap);
                                return;
                            }
                            var restr = col.restricciones || {};
                            var tipoComp = col.tipoComponente != null ? col.tipoComponente : col.tipo;
                            var tipoDato = col.tipoDato != null ? col.tipoDato : col.tipo;
                            var label = document.createElement("label"); label.className = "costos-edit-label"; label.setAttribute("for", "field-" + idx); label.textContent = nombre;
                            var wrap = document.createElement("div"); wrap.className = "costos-edit-field"; wrap.appendChild(label);
                            if (tipoComp === "label" || col.label === true) {
                                var ro = document.createElement("span"); ro.id = "field-" + idx; ro.className = "costos-edit-input costos-edit-readonly";
                                ro.setAttribute("data-header-index", String(idx)); ro.setAttribute("data-nombre", col.nombre || nombre);
                                if (col.formatoVisual) ro.setAttribute("data-formato-visual", col.formatoVisual); if (col.descripcion) ro.title = col.descripcion;
                                var dispVal = val || "—";
                                if ((tipoDato === "numeric" || col.tipo === "numeric") && col.formatoVisual && typeof window.formatNumeroVisual === "function" && val !== "") dispVal = window.formatNumeroVisual(val, col.formatoVisual, col.decimales != null ? col.decimales : 2);
                                ro.textContent = dispVal; wrap.appendChild(ro);
                            } else if (tipoComp === "combo-basico") {
                                function getValoresCombo(ref) { if (typeof ref !== "string") return []; var parts = ref.trim().split("."); if (parts.length < 2) return []; var obj = window[parts[0]]; var key = parts.slice(1).join("."); if (obj && obj[key] && Array.isArray(obj[key])) return obj[key]; return []; }
                                var valoresCombo = (restr.valoresPermitidos && Array.isArray(restr.valoresPermitidos)) ? restr.valoresPermitidos : getValoresCombo(col.comboListadoValores);
                                var select = document.createElement("select"); select.id = "field-" + idx; select.className = "costos-edit-input"; select.setAttribute("data-header-index", String(idx)); select.setAttribute("data-nombre", col.nombre || nombre);
                                if (col.descripcion) select.title = col.descripcion; if (col.obligatorio !== true) { var o = document.createElement("option"); o.value = ""; o.textContent = "—"; select.appendChild(o); }
                                valoresCombo.forEach(function (v) { var o = document.createElement("option"); o.value = (v != null ? String(v) : ""); o.textContent = (v != null && v !== "") ? String(v) : "—"; if (val === (v != null ? String(v) : "")) o.selected = true; select.appendChild(o); });
                                if (col.obligatorio === true) select.required = true; wrap.appendChild(select);
                            } else if ((tipoComp === "text-box") && (tipoDato === "numeric" || col.tipo === "numeric")) {
                                var input = document.createElement("input"); input.type = "number";
                                input.step = (restr.entero === true) ? "1" : (col.decimales != null ? Math.pow(10, -col.decimales) : "0.01");
                                if (restr.min != null) input.min = restr.min; if (restr.max != null) input.max = restr.max;
                                if (col.obligatorio === true) input.required = true; if (col.formatoVisual) input.setAttribute("data-formato-visual", col.formatoVisual); if (col.descripcion) input.title = col.descripcion;
                                input.placeholder = col.decimales != null ? "0." + "0".repeat(col.decimales) : "0";
                                input.id = "field-" + idx; input.className = "costos-edit-input"; input.setAttribute("data-header-index", String(idx)); input.setAttribute("data-nombre", col.nombre || nombre); input.value = val; wrap.appendChild(input);
                            } else {
                                var input = document.createElement("input"); input.type = "text"; input.id = "field-" + idx; input.className = "costos-edit-input"; input.setAttribute("data-header-index", String(idx)); input.setAttribute("data-nombre", col.nombre || nombre); input.value = val;
                                if (restr.maxLongitud) input.maxLength = restr.maxLongitud; if (col.obligatorio === true) input.required = true; if (col.descripcion) input.title = col.descripcion; wrap.appendChild(input);
                            }
                            fieldsContainer.appendChild(wrap);
                        });
                        function getFormValueByNombreProductoUnitario(form, nombre) {
                            if (!form || !nombre) return "";
                            var el = null;
                            form.querySelectorAll("[data-nombre]").forEach(function (e) { if (e.getAttribute("data-nombre") === nombre) el = e; });
                            if (!el) return "";
                            return (el.value != null ? String(el.value).trim() : (el.textContent != null ? String(el.textContent).trim() : ""));
                        }
                        function setFormValueByNombreProductoUnitario(form, nombre, val, decimales) {
                            if (!form || !nombre) return;
                            var el = null;
                            form.querySelectorAll("[data-nombre]").forEach(function (e) { if (e.getAttribute("data-nombre") === nombre) el = e; });
                            if (!el) return;
                            var dec = (decimales != null && !isNaN(decimales)) ? parseInt(decimales, 10) : 2;
                            var col = (sheetConfig.columnas || []).filter(function (c) { return (c.nombre || "") === nombre; })[0] || null;
                            var formato = (col && col.formatoVisual) ? col.formatoVisual : null;
                            if (el.value !== undefined) {
                                el.value = (val != null && val !== "") ? String(val) : "";
                            } else {
                                var disp = (val != null && val !== "") ? String(val) : "—";
                                if (formato && typeof window.formatNumeroVisual === "function" && val !== "" && val != null) {
                                    var num = parseFloat(String(val).replace(",", "."));
                                    if (!isNaN(num)) disp = window.formatNumeroVisual(num, formato, dec);
                                }
                                el.textContent = disp;
                            }
                        }
                        function applyLookupsProductoUnitario(form, sheetConfig, apiUrl) {
                            if (!sheetConfig.lookups || sheetConfig.lookups.length === 0 || !apiUrl) return Promise.resolve();
                            var promesas = sheetConfig.lookups.map(function (lookup) {
                                var claveVal = getFormValueByNombreProductoUnitario(form, lookup.columnaClaveLocal);
                                if (!claveVal) {
                                    setFormValueByNombreProductoUnitario(form, lookup.columnaDestino, "");
                                    return Promise.resolve();
                                }
                                var url = apiUrl + "?action=get&sheet=" + encodeURIComponent(lookup.tablaOrigen) + "&id=" + encodeURIComponent(claveVal);
                                return fetch(url, { cache: "no-store" }).then(function (r) { return r.json(); }).then(function (resp) {
                                    if (!resp || !resp.success || !resp.data) {
                                        setFormValueByNombreProductoUnitario(form, lookup.columnaDestino, "");
                                        return;
                                    }
                                    var data = resp.data;
                                    var val = (data[lookup.columnaOrigen] != null && data[lookup.columnaOrigen] !== "") ? data[lookup.columnaOrigen] : (data[lookup.columnaDestino] != null && data[lookup.columnaDestino] !== "" ? data[lookup.columnaDestino] : null);
                                    var dec = (lookup.decimales != null) ? lookup.decimales : 2;
                                    if (typeof val === "number" && !isNaN(val)) val = val.toFixed(dec);
                                    else if (val != null && val !== "") val = String(val).trim();
                                    else val = "";
                                    setFormValueByNombreProductoUnitario(form, lookup.columnaDestino, val, dec);
                                }).catch(function () { setFormValueByNombreProductoUnitario(form, lookup.columnaDestino, ""); });
                            });
                            return Promise.all(promesas);
                        }
                        function ordenFormulasPorDependencias(formulas) {
                            if (!formulas || typeof formulas !== "object") return [];
                            var nombres = Object.keys(formulas);
                            var orden = [];
                            var restantes = nombres.slice();
                            while (restantes.length > 0) {
                                var agregado = false;
                                for (var r = 0; r < restantes.length; r++) {
                                    var nom = restantes[r];
                                    var f = formulas[nom];
                                    if (!f || !Array.isArray(f.fuentes)) { orden.push(nom); restantes.splice(r, 1); agregado = true; break; }
                                    var depsCumplidas = true;
                                    for (var d = 0; d < f.fuentes.length; d++) { if (nombres.indexOf(f.fuentes[d]) !== -1 && orden.indexOf(f.fuentes[d]) === -1) { depsCumplidas = false; break; } }
                                    if (depsCumplidas) { orden.push(nom); restantes.splice(r, 1); agregado = true; break; }
                                }
                                if (!agregado) break;
                            }
                            return orden.concat(restantes);
                        }
                        function applyFormulasProductoUnitario(form, sheetConfig) {
                            var columnas = (sheetConfig && sheetConfig.columnas) ? sheetConfig.columnas : [];
                            var formulas = (sheetConfig && sheetConfig.formulas) ? sheetConfig.formulas : {};
                            var orden = ordenFormulasPorDependencias(formulas);
                            orden.forEach(function (nombreCol) {
                                var el = null;
                                form.querySelectorAll("[data-nombre]").forEach(function (e) { if (e.getAttribute("data-nombre") === nombreCol) el = e; });
                                if (!el || el.value !== undefined) return;
                                var f = formulas[nombreCol];
                                if (!f || !f.fuentes || !f.expresion) return;
                                var expr = f.expresion;
                                var dec = (f.decimales != null) ? f.decimales : 2;
                                var fuentes = f.fuentes;
                                var exprEval = expr;
                                for (var i = 0; i < fuentes.length; i++) {
                                    var letter = String.fromCharCode(97 + i);
                                    var val = getFormValueByNombreProductoUnitario(form, fuentes[i]);
                                    var colFuente = columnas.filter(function (c) { return (c.nombre || "") === fuentes[i]; })[0] || null;
                                    var num = parseFloat(String(val).replace(",", ".")) || 0;
                                    if (colFuente && colFuente.formatoVisual && typeof window.parseNumeroVisual === "function" && val !== "") {
                                        var raw = window.parseNumeroVisual(val, colFuente.formatoVisual);
                                        if (raw !== "" && raw != null) num = parseFloat(String(raw).replace(",", ".")) || 0;
                                    }
                                    exprEval = exprEval.replace(new RegExp("\\b" + letter + "\\b", "g"), String(num));
                                }
                                var result;
                                try { result = Function("return (" + exprEval + ");")(); } catch (err) { result = 0; }
                                if (typeof result !== "number" || isNaN(result)) result = 0;
                                result = Math.round(result * Math.pow(10, dec)) / Math.pow(10, dec);
                                var col = columnas.filter(function (c) { return (c.nombre || "") === nombreCol; })[0] || null;
                                var formato = (col && col.formatoVisual) ? col.formatoVisual : null;
                                el.textContent = (typeof window.formatNumeroVisual === "function" && formato) ? window.formatNumeroVisual(result, formato, dec) : result.toFixed(dec);
                            });
                        }
                        var saveBtn = formEl.querySelector(".costos-edit-btn-save");
                        var elaboracionSection = document.getElementById("elaboracion-vinculada-section");
                        var elaboracionSinId = document.getElementById("elaboracion-vinculada-sin-id");
                        var elaboracionLoading = document.getElementById("elaboracion-vinculada-loading");
                        var elaboracionTableWrap = document.getElementById("elaboracion-vinculada-table-wrap");
                        var elaboracionThead = document.getElementById("elaboracion-vinculada-thead");
                        var elaboracionTbody = document.getElementById("elaboracion-vinculada-tbody");
                        var ELABORACION_HEADERS = ["Cantidad", "Descripcion-Masa-Producto", "Costo-Produccion-ProductoBase", "Monto"];
                        var ELABORACION_ALIASES = { "Cantidad": "Cantidad", "Descripcion-Masa-Producto": "Descripción Masa", "Costo-Produccion-ProductoBase": "Costo Prod. Base", "Monto": "Monto" };
                        function renderElaboracionVinculada() {
                            if (!elaboracionSection) return;
                            elaboracionSection.style.display = "block";
                            var idElab = getFormValueByNombreProductoUnitario(formEl, "IDElaboracion-ProductoBase");
                            idElab = (idElab != null ? String(idElab).trim() : "");
                            if (idElab === "—" || idElab === "–" || idElab === "-") idElab = "";
                            if (!idElab) {
                                if (elaboracionSinId) elaboracionSinId.style.display = "block";
                                if (elaboracionLoading) elaboracionLoading.style.display = "none";
                                if (elaboracionTableWrap) elaboracionTableWrap.style.display = "none";
                                return;
                            }
                            if (elaboracionSinId) elaboracionSinId.style.display = "none";
                            if (elaboracionLoading) elaboracionLoading.style.display = "block";
                            if (elaboracionTableWrap) elaboracionTableWrap.style.display = "none";
                            var sheetElab = "Tabla-Elaboracion-Productos-Base";
                            var bodyGet = new URLSearchParams();
                            bodyGet.append("action", "get");
                            bodyGet.append("sheet", sheetElab);
                            bodyGet.append("id", idElab);
                            fetch(appsScriptUrl, { method: "POST", body: bodyGet, cache: "no-store" }).then(function (r) { return r.text(); }).then(function (text) {
                                var resp;
                                try { resp = JSON.parse(text); } catch (e) { resp = null; }
                                if (elaboracionLoading) elaboracionLoading.style.display = "none";
                                var data = null;
                                if (resp && resp.success && resp.data != null) {
                                    if (typeof resp.data === "object" && !Array.isArray(resp.data)) data = resp.data;
                                    else if (Array.isArray(resp.data) && resp.data.length > 0) data = resp.data[0];
                                    else if (resp.data && typeof resp.data === "object" && resp.data.rows && resp.data.rows.length > 0) data = resp.data.rows[0];
                                }
                                if (!data) {
                                    if (elaboracionSinId) { elaboracionSinId.textContent = "No se encontró la elaboración vinculada."; elaboracionSinId.style.display = "block"; }
                                    return;
                                }
                                function getDataVal(obj, key) {
                                    if (obj[key] != null && obj[key] !== "") return obj[key];
                                    var k2 = key.replace(/-/g, "");
                                    for (var p in obj) { if (Object.prototype.hasOwnProperty.call(obj, p) && String(p).replace(/-/g, "") === k2) return obj[p]; }
                                    return null;
                                }
                                if (elaboracionThead) {
                                    elaboracionThead.innerHTML = "";
                                    var tr = document.createElement("tr");
                                    ELABORACION_HEADERS.forEach(function (h) { var th = document.createElement("th"); th.scope = "col"; th.textContent = ELABORACION_ALIASES[h] || h; tr.appendChild(th); });
                                    elaboracionThead.appendChild(tr);
                                }
                                if (elaboracionTbody) {
                                    elaboracionTbody.innerHTML = "";
                                    var tr = document.createElement("tr");
                                    ELABORACION_HEADERS.forEach(function (h) {
                                        var td = document.createElement("td");
                                        var rawVal = getDataVal(data, h);
                                        var val = (rawVal != null && rawVal !== "") ? String(rawVal) : "—";
                                        if ((h === "Costo-Produccion-ProductoBase" || h === "Monto") && val !== "—" && typeof window.formatNumeroVisual === "function") {
                                            var num = parseFloat(String(val).replace(",", "."));
                                            if (!isNaN(num)) val = window.formatNumeroVisual(num, "moneda", 2);
                                        }
                                        td.textContent = val;
                                        tr.appendChild(td);
                                    });
                                    elaboracionTbody.appendChild(tr);
                                }
                                if (elaboracionTableWrap) elaboracionTableWrap.style.display = "block";
                            }).catch(function () {
                                if (elaboracionLoading) elaboracionLoading.style.display = "none";
                                if (elaboracionSinId) { elaboracionSinId.textContent = "Error al cargar la elaboración vinculada."; elaboracionSinId.style.display = "block"; }
                            });
                        }
                        applyLookupsProductoUnitario(formEl, sheetConfig, appsScriptUrl).then(function () {
                            applyFormulasProductoUnitario(formEl, sheetConfig);
                            renderElaboracionVinculada();
                        });
                        formEl.querySelectorAll("input[data-nombre], select[data-nombre]").forEach(function (input) {
                            var nombre = input.getAttribute("data-nombre");
                            if (!nombre) return;
                            var esFuenteFormula = false;
                            if (sheetConfig.formulas) {
                                for (var k in sheetConfig.formulas) {
                                    if (sheetConfig.formulas[k].fuentes && sheetConfig.formulas[k].fuentes.indexOf(nombre) !== -1) { esFuenteFormula = true; break; }
                                }
                            }
                            if (esFuenteFormula) {
                                input.addEventListener("input", function () { applyFormulasProductoUnitario(formEl, sheetConfig); updateSaveButton(); });
                                input.addEventListener("change", function () { applyFormulasProductoUnitario(formEl, sheetConfig); updateSaveButton(); });
                            }
                            var esClaveLookup = false;
                            if (sheetConfig.lookups && sheetConfig.lookups.length) {
                                for (var l = 0; l < sheetConfig.lookups.length; l++) {
                                    if (sheetConfig.lookups[l].columnaClaveLocal === nombre) { esClaveLookup = true; break; }
                                }
                            }
                            if (esClaveLookup) {
                                input.addEventListener("input", function () { applyLookupsProductoUnitario(formEl, sheetConfig, appsScriptUrl).then(function () { applyFormulasProductoUnitario(formEl, sheetConfig); updateSaveButton(); }); });
                                input.addEventListener("change", function () { applyLookupsProductoUnitario(formEl, sheetConfig, appsScriptUrl).then(function () { applyFormulasProductoUnitario(formEl, sheetConfig); updateSaveButton(); }); });
                            }
                        });
                        function getCurrentRowFromForm() {
                            var out = []; for (var i = 0; i < headers.length; i++) out[i] = ""; formEl.querySelectorAll("[data-header-index]").forEach(function (el) { var idx = parseInt(el.getAttribute("data-header-index"), 10); if (idx < 0) return; var val = (el.value != null ? String(el.value).trim() : (el.textContent != null ? String(el.textContent).trim() : "")); var formato = el.getAttribute("data-formato-visual"); if (formato && typeof window.parseNumeroVisual === "function") val = window.parseNumeroVisual(val, formato) || val; if (idx < out.length) out[idx] = val; }); return out;
                        }
                        var initialRow = getCurrentRowFromForm();
                        if (saveBtn) saveBtn.disabled = true;
                        function hasFormChanged() { var cur = getCurrentRowFromForm(); for (var i = 0; i < headers.length; i++) { if ((cur[i] || "") !== (initialRow[i] || "")) return true; } return false; }
                        function updateSaveButton() { if (saveBtn) saveBtn.disabled = !hasFormChanged(); }
                        formEl.addEventListener("input", updateSaveButton); formEl.addEventListener("change", updateSaveButton);
                        formEl.addEventListener("submit", function (e) {
                            e.preventDefault(); hideEditAlert();
                            var newRow = row.slice ? row.slice() : row.map(function (x) { return x; });
                            formEl.querySelectorAll("[data-header-index]").forEach(function (el) {
                                var idx = parseInt(el.getAttribute("data-header-index"), 10);
                                if (idx < 0) return;
                                var val = (el.value != null ? String(el.value).trim() : (el.textContent != null ? String(el.textContent).trim() : ""));
                                var formato = el.getAttribute("data-formato-visual");
                                if (formato && typeof window.parseNumeroVisual === "function") val = window.parseNumeroVisual(val, formato) || val;
                                while (newRow.length <= idx) newRow.push("");
                                newRow[idx] = val;
                            });
                            var body = { action: "update", sheet: nombreHoja, id: id };
                            for (var k = 0; k < headers.length; k++) { if (headers[k]) body[headers[k]] = newRow[k] != null ? newRow[k] : ""; }
                            var formBody = new URLSearchParams();
                            for (var key in body) { if (body.hasOwnProperty(key)) formBody.append(key, body[key] != null ? body[key] : ""); }
                            var btnText = saveBtn ? saveBtn.innerHTML : "";
                            if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = "<i class=\"fa-solid fa-spinner fa-spin\" aria-hidden=\"true\"></i> Guardando…"; }
                            if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.show("Guardando…");
                            fetch(appsScriptUrl, { method: "POST", body: formBody }).then(function (res) { return res.text(); }).then(function (text) {
                                var json; try { json = JSON.parse(text); } catch (err) { throw new Error("Respuesta no válida"); } return json;
                            }).then(function (json) {
                                if (saveBtn) { saveBtn.disabled = !hasFormChanged(); saveBtn.innerHTML = btnText; }
                                hideEditAlert();
                                if (json && json.success) { try { sessionStorage.setItem(STORAGE_EDIT, JSON.stringify({ id: id, headers: headers, row: newRow })); } catch (e) {} window.location.replace("producto-unitario-base.html"); }
                                else { showEditAlert("Error al guardar: " + ((json && json.error) ? json.error : "Respuesta inválida"), "error"); }
                            }).catch(function (err) {
                                if (saveBtn) { saveBtn.disabled = !hasFormChanged(); saveBtn.innerHTML = btnText; }
                                showEditAlert("Error de conexión: " + (err.message || ""), "error");
                            }).finally(function () { if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.hide(); });
                        });
                    }).catch(function (err) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "Error: " + (err.message || ""); formEl.style.display = "none"; });
                }
            }
        })();
    </script>
</body>
</html>
