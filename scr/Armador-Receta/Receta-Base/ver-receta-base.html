<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ver Receta - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../costos/costos.css">
    <script src="../../Arquitectura/config.js"></script>
    <script src="../../Arquitectura/config-sheets.js"></script>
    <script src="../../Arquitectura/sheets/receta-base/receta-base-sheets-base.js"></script>
    <script src="../../Arquitectura/sheets/receta-base/sheets-ver-receta-base.config.js"></script>
    <script>window.RECETA_BASE_ACCION_ACTUAL = "ver";</script>
</head>
<body class="costos-page">
    <nav class="costos-nav" aria-label="Navegación principal">
        <a href="../../../index.html" class="costos-nav-link">Inicio</a>
        <a href="../armador-receta.html" class="costos-nav-link">Armador de Receta</a>
        <a href="receta-base.html" class="costos-nav-link" data-accion="listar">Receta Base</a>
        <a href="../Producto-Unitario-Base/producto-unitario-base.html" class="costos-nav-link">Producto Unitario Base</a>
        <a href="../Elaboracion-Productos-Base/elaboracion-productos-base.html" class="costos-nav-link">Elaboración Productos Base</a>
    </nav>
    <main class="costos-main">
        <h1 class="costos-title costos-title--con-icono"><i class="fa-solid fa-eye costos-title-icono" aria-hidden="true"></i> Ver Receta</h1>
        <p class="costos-intro">Datos del registro. Solo visualización.</p>
        <div id="ver-container" class="costos-datos">
            <p id="ver-no-data" class="costos-placeholder" style="display:none;">No hay datos del registro. Volvé al listado y usá «Ver».</p>
            <p id="ver-loading" class="costos-placeholder">Cargando…</p>
            <div id="ver-detalle" class="costos-ver-detalle" style="display:none;"></div>
            <div id="ver-actions" class="costos-edit-actions" style="display:none;">
                <a href="receta-base.html" class="costos-edit-btn-cancel">Volver al listado</a>
                <a href="#" id="btn-agregar-item-receta" class="costos-edit-btn-save" style="margin-left: auto;"><i class="fa-solid fa-plus" aria-hidden="true"></i> Agregar Item de la Receta</a>
                <a href="editar-receta-base.html" class="costos-edit-btn-save"><i class="fa-solid fa-pen" aria-hidden="true"></i> Editar</a>
            </div>
            <section id="ver-items-receta" class="costos-datos costos-ver-items-receta" style="display:none; margin-top: 2rem;">
                <h2 class="costos-subtitle">Items de la receta</h2>
                <p id="ver-items-loading" class="costos-placeholder">Cargando ítems…</p>
                <p id="ver-items-empty" class="costos-placeholder" style="display:none;">No hay ítems en esta receta. Usá «Agregar Item de la Receta» para cargar materia prima.</p>
                <div id="ver-items-container" class="costos-table-wrap" style="display:none;">
                    <table class="costos-table costos-ver-items-table" aria-label="Items de la receta (Tabla-Receta-Base-Detalle)">
                        <thead id="ver-items-thead"></thead>
                        <tbody id="ver-items-tbody"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
    <script src="../../Arquitectura/sheets/receta-base/receta-base-config.js"></script>
    <script>if (window.RECETA_BASE_APPLY_NAV) window.RECETA_BASE_APPLY_NAV();</script>
    <script>
        (function () {
            var STORAGE_EDIT = "costosEditRecordRecetaBase";
            function norm(s) { return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, "").replace(/-/g, ""); }
            function mapRowToConfigOrder(rowFromStorage, headersFromStorage, columnas) {
                var configNombres = columnas.map(function (c) { return c.nombre; });
                var out = [];
                for (var i = 0; i < configNombres.length; i++) {
                    var nombre = configNombres[i];
                    var idx = -1;
                    for (var j = 0; j < headersFromStorage.length; j++) { if (norm(headersFromStorage[j]) === norm(nombre)) { idx = j; break; } }
                    out.push(idx >= 0 ? (rowFromStorage[idx] != null ? String(rowFromStorage[idx]) : "") : "");
                }
                return out;
            }
            function escapeHtml(text) { if (text == null) return ""; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
            function renderVerDetalle(detalleEl, columnas, row, escapeHtmlFn) {
                var html = "<dl class=\"costos-ver-dl\">";
                columnas.forEach(function (col, idx) {
                    if (col.visible === false || col.visible === "false") return;
                    var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                    if (!nombre) return;
                    var val = (row[idx] != null && row[idx] !== "") ? String(row[idx]).trim() : "—";
                    if ((col.tipoDato === "numeric" || col.tipo === "numeric") && col.formatoVisual && typeof window.formatNumeroVisual === "function" && val !== "—") {
                        var num = parseFloat(String(val).replace(",", "."));
                        if (!isNaN(num)) val = window.formatNumeroVisual(num, col.formatoVisual, col.decimales != null ? col.decimales : 2);
                    }
                    var nombreCol = (col.nombre || "").trim();
                    html += "<dt class=\"costos-ver-dt\">" + escapeHtmlFn(nombre) + "</dt><dd class=\"costos-ver-dd\" data-nombre=\"" + escapeHtmlFn(nombreCol) + "\">" + escapeHtmlFn(val) + "</dd>";
                });
                html += "</dl>";
                detalleEl.innerHTML = html;
            }
            var noDataEl = document.getElementById("ver-no-data"); var loadingEl = document.getElementById("ver-loading"); var detalleEl = document.getElementById("ver-detalle"); var actionsEl = document.getElementById("ver-actions");
            var raw = sessionStorage.getItem(STORAGE_EDIT);
            if (!raw) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; } else {
                var loadConfig = window.RECETA_BASE_LOAD_CONFIG;
                if (!loadConfig) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "No se pudo cargar la configuración."; } else {
                    loadConfig().then(function (sheetConfig) {
                        var data; try { data = JSON.parse(raw); } catch (e) { data = {}; }
                        var headersFromStorage = data.headers || []; var rowFromStorage = data.row || [];
                        var columnas = sheetConfig.columnas || []; var row = mapRowToConfigOrder(rowFromStorage, headersFromStorage, columnas);
                        loadingEl.style.display = "none"; detalleEl.style.display = "block"; actionsEl.style.display = "block";
                        var html = "<dl class=\"costos-ver-dl\">";
                        columnas.forEach(function (col, idx) {
                            if (col.visible === false || col.visible === "false") return;
                            var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                            if (!nombre) return;
                            var val = (row[idx] != null && row[idx] !== "") ? String(row[idx]).trim() : "—";
                            if ((col.tipoDato === "numeric" || col.tipo === "numeric") && col.formatoVisual && typeof window.formatNumeroVisual === "function" && val !== "—") {
                                var num = parseFloat(String(val).replace(",", "."));
                                if (!isNaN(num)) val = window.formatNumeroVisual(num, col.formatoVisual, col.decimales != null ? col.decimales : 2);
                            }
                            var nombreCol = (col.nombre || "").trim();
                            html += "<dt class=\"costos-ver-dt\">" + escapeHtml(nombre) + "</dt><dd class=\"costos-ver-dd\" data-nombre=\"" + escapeHtml(nombreCol) + "\">" + escapeHtml(val) + "</dd>";
                        });
                        html += "</dl>";
                        detalleEl.innerHTML = html;
                        var idRecetaBase = "";
                        var ddId = detalleEl.querySelector("dd[data-nombre=\"IDReceta-Base\"]");
                        if (ddId && ddId.textContent) idRecetaBase = String(ddId.textContent).trim();
                        if (idRecetaBase === "—") idRecetaBase = "";
                        var btnAgregar = document.getElementById("btn-agregar-item-receta");
                        if (btnAgregar) {
                            btnAgregar.addEventListener("click", function (e) {
                                e.preventDefault();
                                var descripcionMasaProducto = "";
                                var ddDesc = detalleEl.querySelector("dd[data-nombre=\"Descripcion-Masa-Producto\"]");
                                if (ddDesc && ddDesc.textContent) descripcionMasaProducto = String(ddDesc.textContent).trim();
                                if (descripcionMasaProducto === "—") descripcionMasaProducto = "";
                                try {
                                    if (idRecetaBase) sessionStorage.setItem("recetaBaseIdForNewItem", idRecetaBase);
                                    if (descripcionMasaProducto) sessionStorage.setItem("recetaBaseDescripcionForNewItem", descripcionMasaProducto);
                                } catch (err) {}
                                window.location.href = "../Receta-Detalle/crear-receta-detalle.html";
                            });
                        }
                        var sectionItems = document.getElementById("ver-items-receta");
                        var itemsLoading = document.getElementById("ver-items-loading");
                        var itemsEmpty = document.getElementById("ver-items-empty");
                        var itemsContainer = document.getElementById("ver-items-container");
                        var thead = document.getElementById("ver-items-thead");
                        var tbody = document.getElementById("ver-items-tbody");
                        if (sectionItems && idRecetaBase) {
                            sectionItems.style.display = "block";
                            var config = window.APP_CONFIG || {};
                            var appsScriptUrl = (config.appsScriptUrl || "").trim();
                            function deshabilitarAcciones() {
                                if (!actionsEl) return;
                                actionsEl.querySelectorAll("a, button").forEach(function (b) {
                                    if (b.tagName === "BUTTON") b.disabled = true;
                                    else { b.classList.add("costos-btn-disabled"); b.setAttribute("aria-disabled", "true"); }
                                });
                            }
                            function habilitarAcciones() {
                                if (!actionsEl) return;
                                actionsEl.querySelectorAll("a, button").forEach(function (b) {
                                    if (b.tagName === "BUTTON") b.disabled = false;
                                    else { b.classList.remove("costos-btn-disabled"); b.removeAttribute("aria-disabled"); }
                                });
                            }
                            if (appsScriptUrl && thead && tbody) {
                                deshabilitarAcciones();
                                var urlItems = appsScriptUrl + "?action=search&sheet=Tabla-Receta-Base-Detalle&IDReceta-Base=" + encodeURIComponent(idRecetaBase) + "&limit=500&_=" + Date.now();
                                fetch(urlItems, { cache: "no-store" }).then(function (r) { return r.json(); }).then(function (json) {
                                    if (itemsLoading) itemsLoading.style.display = "none";
                                    if (!json || !json.success || !json.data) {
                                        if (itemsEmpty) { itemsEmpty.style.display = "block"; itemsEmpty.textContent = "No se pudieron cargar los ítems."; }
                                        habilitarAcciones();
                                        return;
                                    }
                                    var headers = json.data.headers || [];
                                    var rows = json.data.rows || [];
                                    if (rows.length === 0) {
                                        if (itemsEmpty) itemsEmpty.style.display = "block";
                                        var ddCostoDirectoVacio = detalleEl ? detalleEl.querySelector("dd[data-nombre=\"Costo-Directo-Receta\"]") : null;
                                        if (ddCostoDirectoVacio) ddCostoDirectoVacio.textContent = (typeof window.formatNumeroVisual === "function") ? window.formatNumeroVisual(0, "moneda", 2) : "0,00";
                                        var confCostoVacio = (window.RECETA_BASE_SHEET_BASE && window.RECETA_BASE_SHEET_BASE.hoja && window.RECETA_BASE_SHEET_BASE.hoja.costoDirectoDesdeDetalle) || {};
                                        var colDestinoVacio = (confCostoVacio.columnaDestino || "Costo-Directo-Receta").trim();
                                        var bodyUpdateVacio = new URLSearchParams();
                                        bodyUpdateVacio.append("action", "update");
                                        bodyUpdateVacio.append("sheet", "Tabla-Receta-Base");
                                        bodyUpdateVacio.append("IDReceta-Base", idRecetaBase);
                                        bodyUpdateVacio.append(colDestinoVacio, "0");
                                        fetch(appsScriptUrl, { method: "POST", body: bodyUpdateVacio }).catch(function () {}).finally(function () {
                                            var urlGetRbVacio = appsScriptUrl + "?action=get&sheet=Tabla-Receta-Base&id=" + encodeURIComponent(idRecetaBase) + "&_=" + Date.now();
                                            fetch(urlGetRbVacio, { cache: "no-store" }).then(function (res) { return res.json(); }).then(function (jsonRb) {
                                                if (!jsonRb || !jsonRb.success || !jsonRb.data || typeof jsonRb.data !== "object") return;
                                                var dataRb = jsonRb.data;
                                                var headersNew = columnas.map(function (c) { return c.nombre; });
                                                var rowNew = headersNew.map(function (h) { return (dataRb[h] != null && dataRb[h] !== "") ? String(dataRb[h]).trim() : ""; });
                                                var idxCostoVacio = headersNew.indexOf(colDestinoVacio);
                                                if (idxCostoVacio >= 0) rowNew[idxCostoVacio] = 0;
                                                try { sessionStorage.setItem(STORAGE_EDIT, JSON.stringify({ id: idRecetaBase, headers: headersNew, row: rowNew })); } catch (e) {}
                                                renderVerDetalle(detalleEl, columnas, rowNew, escapeHtml);
                                            }).catch(function () {}).finally(habilitarAcciones);
                                        });
                                        return;
                                    }
                                    var columnasVer = [
                                        { nombre: "Nombre-Insumo", alias: "Nombre Insumo" },
                                        { nombre: "Cantidad", alias: "Cantidad" },
                                        { nombre: "Unidad-Medida", alias: "Unidad Medida" },
                                        { nombre: "Precio-Equivalencia-x-Unidad", alias: "Precio x Unidad" },
                                        { nombre: "Importe", alias: "Importe" }
                                    ];
                                    var idxCols = columnasVer.map(function (c) { return headers.indexOf(c.nombre); });
                                    var idxImporte = headers.indexOf("Importe");
                                    thead.innerHTML = "<tr>" + columnasVer.map(function (c) { return "<th scope=\"col\">" + escapeHtml(c.alias) + "</th>"; }).join("") + "</tr>";
                                    tbody.innerHTML = "";
                                    var sumaImporte = 0;
                                    for (var r = 0; r < rows.length; r++) {
                                        var rowRaw = rows[r];
                                        var rowArr = Array.isArray(rowRaw) ? rowRaw : [];
                                        var rowObj = (typeof rowRaw === "object" && rowRaw !== null && !Array.isArray(rowRaw)) ? rowRaw : null;
                                        var cells = [];
                                        for (var c = 0; c < idxCols.length; c++) {
                                            var val = "—";
                                            if (rowObj && rowObj[columnasVer[c].nombre] != null && rowObj[columnasVer[c].nombre] !== "") val = String(rowObj[columnasVer[c].nombre]).trim();
                                            else if (rowArr.length) { var idx = idxCols[c]; if (idx >= 0 && idx < rowArr.length && rowArr[idx] != null && rowArr[idx] !== "") val = String(rowArr[idx]).trim(); }
                                            if (val !== "—" && (columnasVer[c].nombre === "Cantidad" || columnasVer[c].nombre === "Precio-Equivalencia-x-Unidad" || columnasVer[c].nombre === "Importe")) {
                                                var num = parseFloat(String(val).replace(",", "."));
                                                if (!isNaN(num) && typeof window.formatNumeroVisual === "function") val = window.formatNumeroVisual(num, "moneda", 2);
                                            }
                                            cells.push("<td>" + escapeHtml(val) + "</td>");
                                        }
                                        var importeNum = 0;
                                        if (rowObj && rowObj["Importe"] != null && rowObj["Importe"] !== "") importeNum = parseFloat(String(rowObj["Importe"]).replace(",", ".")) || 0;
                                        else if (idxImporte >= 0 && rowArr[idxImporte] != null && rowArr[idxImporte] !== "") importeNum = parseFloat(String(rowArr[idxImporte]).replace(",", ".")) || 0;
                                        sumaImporte += importeNum;
                                        tbody.innerHTML += "<tr>" + cells.join("") + "</tr>";
                                    }
                                    var ddCostoDirecto = detalleEl ? detalleEl.querySelector("dd[data-nombre=\"Costo-Directo-Receta\"]") : null;
                                    if (ddCostoDirecto) {
                                        ddCostoDirecto.textContent = (typeof window.formatNumeroVisual === "function") ? window.formatNumeroVisual(sumaImporte, "moneda", 2) : sumaImporte.toFixed(2);
                                    }
                                    if (itemsContainer) itemsContainer.style.display = "block";
                                    var confCosto = (window.RECETA_BASE_SHEET_BASE && window.RECETA_BASE_SHEET_BASE.hoja && window.RECETA_BASE_SHEET_BASE.hoja.costoDirectoDesdeDetalle) || {};
                                    var colDestino = (confCosto.columnaDestino || "Costo-Directo-Receta").trim();
                                    var bodyUpdate = new URLSearchParams();
                                    bodyUpdate.append("action", "update");
                                    bodyUpdate.append("sheet", "Tabla-Receta-Base");
                                    bodyUpdate.append("IDReceta-Base", idRecetaBase);
                                    bodyUpdate.append(colDestino, String(sumaImporte));
                                    fetch(appsScriptUrl, { method: "POST", body: bodyUpdate }).catch(function () {}).finally(function () {
                                        var urlGetRb = appsScriptUrl + "?action=get&sheet=Tabla-Receta-Base&id=" + encodeURIComponent(idRecetaBase) + "&_=" + Date.now();
                                        fetch(urlGetRb, { cache: "no-store" }).then(function (res) { return res.json(); }).then(function (jsonRb) {
                                            if (!jsonRb || !jsonRb.success || !jsonRb.data || typeof jsonRb.data !== "object") return;
                                            var dataRb = jsonRb.data;
                                            var headersNew = columnas.map(function (c) { return c.nombre; });
                                            var rowNew = headersNew.map(function (h) { return (dataRb[h] != null && dataRb[h] !== "") ? String(dataRb[h]).trim() : ""; });
                                            var idxCosto = headersNew.indexOf(colDestino);
                                            if (idxCosto >= 0) rowNew[idxCosto] = sumaImporte;
                                            try { sessionStorage.setItem(STORAGE_EDIT, JSON.stringify({ id: idRecetaBase, headers: headersNew, row: rowNew })); } catch (e) {}
                                            renderVerDetalle(detalleEl, columnas, rowNew, escapeHtml);
                                        }).catch(function () {}).finally(habilitarAcciones);
                                    });
                                }).catch(function (err) {
                                    if (itemsLoading) itemsLoading.style.display = "none";
                                    if (itemsEmpty) { itemsEmpty.style.display = "block"; itemsEmpty.textContent = "Error al cargar ítems: " + (err.message || ""); }
                                    habilitarAcciones();
                                });
                            } else {
                                if (itemsLoading) itemsLoading.style.display = "none";
                                if (itemsEmpty) itemsEmpty.style.display = "block";
                            }
                        }
                    }).catch(function (err) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "Error: " + (err.message || ""); });
                }
            }
        })();
    </script>
</body>
</html>
