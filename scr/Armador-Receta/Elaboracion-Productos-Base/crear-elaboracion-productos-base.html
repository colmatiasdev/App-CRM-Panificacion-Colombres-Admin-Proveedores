<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Crear elaboración productos base - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../costos/costos.css">
    <script src="../../Arquitectura/config.js"></script>
    <script src="../../Arquitectura/config-sheets.js"></script>
    <script src="../../Arquitectura/generar-id.js"></script>
    <script src="../../Arquitectura/sheets/elaboracion-productos-base/elaboracion-productos-base-sheets-base.js"></script>
    <script src="../../Arquitectura/sheets/elaboracion-productos-base/sheets-crear-elaboracion-productos-base.config.js"></script>
    <script src="../armador-receta-hub.config.js"></script>
    <script>window.ELABORACION_PRODUCTOS_BASE_ACCION_ACTUAL = "crear"; window.ARMADOR_RECETA_SUBMODULO_ACTUAL = "elaboracion-productos-base";</script>
</head>
<body class="costos-page">
    <nav class="costos-nav" id="armador-receta-nav" aria-label="Navegación principal"></nav>
    <main class="costos-main">
        <h1 class="costos-title">Crear elaboración productos base</h1>
        <p class="costos-intro">Completá los datos según la hoja <strong>Tabla-Elaboracion-ProductosBase</strong>.</p>
        <div id="edit-form-container" class="costos-datos">
            <div id="costos-edit-alert" class="costos-alert" role="alert" style="display:none;"></div>
            <p id="edit-no-data" class="costos-placeholder" style="display:none;">No se pudo cargar el formulario.</p>
            <p id="edit-loading" class="costos-placeholder">Cargando formulario…</p>
            <section id="costos-edit-cabecera" class="costos-edit-cabecera" style="display:none;" aria-label="Información de cabecera del registro">
                <h2 class="costos-edit-seccion-titulo">Información de cabecera</h2>
                <div id="costos-edit-cabecera-content" class="costos-edit-cabecera-content"></div>
            </section>
            <form id="costos-edit-form" class="costos-edit-form" style="display:none;">
                <div id="edit-fields"></div>
                <div class="costos-edit-actions">
                    <a href="elaboracion-productos-base.html" class="costos-edit-btn-cancel">Volver al listado</a>
                    <button type="submit" class="costos-edit-btn-save"><i class="fa-solid fa-plus" aria-hidden="true"></i> Crear</button>
                </div>
            </form>
        </div>
    </main>
    <script src="../armador-receta-nav.js"></script>
    <script src="../../Arquitectura/sheets/elaboracion-productos-base/elaboracion-productos-base-config.js"></script>
    <script>
        (function () {
            var config = window.APP_CONFIG || {};
            var appsScriptUrl = (config.appsScriptUrl || "").trim();
            function norm(s) { return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, "").replace(/-/g, ""); }
            function isClavePrimaria(nombre, clavePrimaria) { var n = norm(nombre); for (var i = 0; i < (clavePrimaria || []).length; i++) { if (norm(clavePrimaria[i]) === n) return true; } return false; }
            var noDataEl = document.getElementById("edit-no-data"); var loadingEl = document.getElementById("edit-loading"); var formEl = document.getElementById("costos-edit-form"); var fieldsContainer = document.getElementById("edit-fields"); var alertEl = document.getElementById("costos-edit-alert"); var cabeceraEl = document.getElementById("costos-edit-cabecera"); var cabeceraContent = document.getElementById("costos-edit-cabecera-content");
            function showEditAlert(message, type) { if (!alertEl) return; alertEl.textContent = message; alertEl.className = "costos-alert costos-alert--" + (type === "success" ? "success" : "error"); alertEl.style.display = "block"; }
            function hideEditAlert() { if (alertEl) { alertEl.style.display = "none"; alertEl.textContent = ""; alertEl.className = "costos-alert"; } }
            if (!appsScriptUrl) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "No está configurada la URL de la API."; return; }
            var loadConfig = window.ELABORACION_PRODUCTOS_BASE_LOAD_CONFIG;
            if (!loadConfig) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "No se pudo cargar la configuración."; return; }
            loadConfig().then(function (sheetConfig) {
                var nombreHoja = sheetConfig.nombreHoja;
                var clavePrimaria = sheetConfig.clavePrimaria || [];
                var columnas = sheetConfig.columnas || [];
                var columnasPropias = sheetConfig.columnasPropias || [];
                var nombresPropias = columnasPropias.map(function (n) { return String(n || "").trim(); });
                function enColumnasPropias(nombreCol) { var n = String(nombreCol || "").trim().toLowerCase(); for (var i = 0; i < nombresPropias.length; i++) { if (String(nombresPropias[i] || "").toLowerCase().replace(/-/g, "") === n.replace(/-/g, "")) return true; } return false; }
                loadingEl.style.display = "none"; formEl.style.display = "block"; fieldsContainer.innerHTML = "";
                var headers = columnas.map(function (c) { return c.nombre; });
                var idGeneradoPreview = (window.GENERAR_ID_PARA_HOJA && sheetConfig.clavePrimaria && sheetConfig.clavePrimaria[0]) ? window.GENERAR_ID_PARA_HOJA(sheetConfig) : "";
                columnas.forEach(function (col, idx) {
                    var nombreCol = (col.nombre || "").trim();
                    if (!enColumnasPropias(nombreCol) || col.visible === false) return;
                    var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                    if (!nombre) return;
                    var restr = col.restricciones || {};
                    var tipoComp = col.tipoComponente != null ? col.tipoComponente : col.tipo;
                    var tipoDato = col.tipoDato != null ? col.tipoDato : col.tipo;
                    var soloLectura = tipoComp === "label";
                    var esPkAutogenerado = isClavePrimaria(nombreCol, clavePrimaria) && idGeneradoPreview !== "";
                    var label = document.createElement("label"); label.className = "costos-edit-label"; label.setAttribute("for", "field-" + idx); label.textContent = nombre;
                    var wrap = document.createElement("div"); wrap.className = "costos-edit-field"; wrap.appendChild(label);
                    if (soloLectura || esPkAutogenerado) {
                        var valorMostrar = esPkAutogenerado ? idGeneradoPreview : (col.descripcion || "Solo lectura");
                        if (col.formatoVisual && typeof window.formatNumeroVisual === "function") { var numVal = parseFloat(String(valorMostrar).replace(",", ".")); if (!isNaN(numVal)) valorMostrar = window.formatNumeroVisual(numVal, col.formatoVisual, col.decimales != null ? col.decimales : 2); }
                        var ro = document.createElement("span"); ro.id = "field-" + idx; ro.className = "costos-edit-input costos-edit-readonly"; ro.setAttribute("data-header-index", String(idx)); ro.setAttribute("data-nombre", nombreCol);
                        if (col.formatoVisual) ro.setAttribute("data-formato-visual", col.formatoVisual); if (col.descripcion) ro.title = col.descripcion; ro.setAttribute("aria-readonly", "true"); ro.textContent = valorMostrar; wrap.appendChild(ro);
                        if (nombreCol === "IDElaboracion-ProductoBase") {
                            var btnMasa = document.createElement("button"); btnMasa.type = "button"; btnMasa.className = "costos-edit-btn costos-edit-btn-seleccionar-masa"; btnMasa.textContent = "SELECCIONAR Masa de la Receta";
                            btnMasa.addEventListener("click", function () {
                                try { sessionStorage.setItem("elaboracionProductosBaseCrearReturnUrl", window.location.href); } catch (e) {}
                                window.location.href = "../Receta-Base/seleccionar-lista-receta-base.html";
                            });
                            wrap.appendChild(btnMasa);
                        }
                    } else if (tipoComp === "combo-basico") {
                        function getValoresCombo(ref) { if (typeof ref !== "string") return []; var parts = ref.trim().split("."); if (parts.length < 2) return []; var obj = window[parts[0]]; var key = parts.slice(1).join("."); if (obj && obj[key] && Array.isArray(obj[key])) return obj[key]; return []; }
                        var valoresCombo = (restr.valoresPermitidos && Array.isArray(restr.valoresPermitidos)) ? restr.valoresPermitidos : getValoresCombo(col.comboListadoValores);
                        var select = document.createElement("select"); select.id = "field-" + idx; select.className = "costos-edit-input"; select.setAttribute("data-header-index", String(idx)); select.setAttribute("data-nombre", nombreCol);
                        if (col.descripcion) select.title = col.descripcion; if (col.obligatorio !== true) { var o = document.createElement("option"); o.value = ""; o.textContent = "—"; select.appendChild(o); }
                        valoresCombo.forEach(function (v) { var o = document.createElement("option"); o.value = (v != null ? String(v) : ""); o.textContent = (v != null && v !== "") ? String(v) : "—"; select.appendChild(o); });
                        if (col.obligatorio === true) select.required = true; wrap.appendChild(select);
                    } else if (tipoComp === "text-box" && (tipoDato === "numeric" || col.tipo === "numeric")) {
                        var input = document.createElement("input"); input.type = "number"; input.step = (restr.entero === true) ? "1" : (col.decimales != null ? Math.pow(10, -col.decimales) : "0.01");
                        if (restr.min != null) input.min = restr.min; if (restr.max != null) input.max = restr.max;
                        if (col.obligatorio === true) input.required = true; if (col.formatoVisual) input.setAttribute("data-formato-visual", col.formatoVisual); if (col.decimales != null) input.setAttribute("data-decimales", String(col.decimales)); if (col.descripcion) input.title = col.descripcion;
                        input.placeholder = col.decimales != null ? "0." + "0".repeat(col.decimales) : "0";
                        input.id = "field-" + idx; input.className = "costos-edit-input"; input.setAttribute("data-header-index", String(idx)); input.setAttribute("data-nombre", nombreCol); wrap.appendChild(input);
                    } else {
                        var input = document.createElement("input"); input.type = "text"; input.id = "field-" + idx; input.className = "costos-edit-input"; input.setAttribute("data-header-index", String(idx)); input.setAttribute("data-nombre", nombreCol);
                        if (restr.maxLongitud) input.maxLength = restr.maxLongitud; if (col.obligatorio === true) input.required = true; if (col.descripcion) input.title = col.descripcion; wrap.appendChild(input);
                    }
                    fieldsContainer.appendChild(wrap);
                });
                var datosProductoUnitario = null;
                try { var raw = sessionStorage.getItem("productoUnitarioBaseParaElaboracion"); if (raw) { datosProductoUnitario = JSON.parse(raw); } } catch (e) {}
                if (datosProductoUnitario && datosProductoUnitario.id != null) {
                    var prevHeaders = datosProductoUnitario.headers || [];
                    var prevRow = datosProductoUnitario.row || [];
                    var idProducto = String(datosProductoUnitario.id);
                    formEl.querySelectorAll("[data-nombre]").forEach(function (el) {
                        var nom = el.getAttribute("data-nombre");
                        if (nom === "IDReceta-Base") { if (el.value !== undefined) el.value = idProducto; else if (el.textContent !== undefined) el.textContent = idProducto; }
                        else if (nom === "Costo-Produccion-ProductoBase" && prevHeaders.length && prevRow.length) {
                            var idxPrev = prevHeaders.indexOf("Costo-Produccion"); if (idxPrev < 0) idxPrev = prevHeaders.indexOf("Costo-Produccion-ProductoBase");
                            if (idxPrev >= 0 && prevRow[idxPrev] != null && String(prevRow[idxPrev]).trim() !== "") { if (el.value !== undefined) el.value = String(prevRow[idxPrev]).trim(); else if (el.textContent !== undefined) el.textContent = String(prevRow[idxPrev]).trim(); }
                        }
                    });
                }
                var recetaSeleccionada = null;
                try { var rawRb = sessionStorage.getItem("recetaBaseSeleccionadaParaElaboracion"); if (rawRb) { recetaSeleccionada = JSON.parse(rawRb); sessionStorage.removeItem("recetaBaseSeleccionadaParaElaboracion"); } } catch (e) {}
                if (recetaSeleccionada && recetaSeleccionada.id != null) {
                    formEl.querySelectorAll("[data-nombre]").forEach(function (el) {
                        var nom = el.getAttribute("data-nombre");
                        if (nom === "IDReceta-Base" && (el.value !== undefined || el.textContent !== undefined)) { if (el.value !== undefined) el.value = String(recetaSeleccionada.id); else el.textContent = String(recetaSeleccionada.id); }
                        else if (nom === "Descripcion-Masa-Producto" && recetaSeleccionada.DescripcionMasaProducto != null) { if (el.value !== undefined) el.value = String(recetaSeleccionada.DescripcionMasaProducto); else if (el.textContent !== undefined) el.textContent = String(recetaSeleccionada.DescripcionMasaProducto); }
                        else if (nom === "Costo-Produccion-ProductoBase" && recetaSeleccionada.CostoProduccionProductoBase != null) { if (el.value !== undefined) el.value = String(recetaSeleccionada.CostoProduccionProductoBase); else if (el.textContent !== undefined) el.textContent = String(recetaSeleccionada.CostoProduccionProductoBase); }
                    });
                }
                if (cabeceraEl && cabeceraContent) {
                    cabeceraContent.innerHTML = "";
                    var ph = (datosProductoUnitario && datosProductoUnitario.headers) ? datosProductoUnitario.headers : [];
                    var pr = (datosProductoUnitario && datosProductoUnitario.row) ? datosProductoUnitario.row : [];
                    function valFromRow(headerName) {
                        var i = ph.indexOf(headerName);
                        return (i >= 0 && pr[i] != null && String(pr[i]).trim() !== "") ? String(pr[i]).trim() : "—";
                    }
                    var itemsCabecera = [
                        { label: "ID Costo Producto Unitario", value: (datosProductoUnitario && datosProductoUnitario.id != null) ? String(datosProductoUnitario.id) : valFromRow("IDCosto-ProductoUnitario") },
                        { label: "Comercio-Sucursal", value: valFromRow("Comercio-Sucursal") },
                        { label: "Categoría", value: valFromRow("Categoria") },
                        { label: "Nombre-Producto", value: valFromRow("Nombre-Producto") }
                    ];
                    itemsCabecera.forEach(function (item) {
                        var row = document.createElement("div");
                        row.className = "costos-edit-cabecera-row";
                        var lbl = document.createElement("span");
                        lbl.className = "costos-edit-cabecera-label";
                        lbl.textContent = (item.label || "") + ":";
                        var val = document.createElement("span");
                        val.className = "costos-edit-cabecera-value";
                        val.textContent = item.value != null ? item.value : "—";
                        row.appendChild(lbl);
                        row.appendChild(document.createTextNode(" "));
                        row.appendChild(val);
                        cabeceraContent.appendChild(row);
                    });
                    cabeceraEl.style.display = "block";
                }
                if (sheetConfig.formulas && sheetConfig.formulas.Monto) {
                    var inputCant = formEl.querySelector("[data-nombre=\"Cantidad\"]");
                    var inputCosto = formEl.querySelector("[data-nombre=\"Costo-Produccion-ProductoBase\"]");
                    var inputMonto = formEl.querySelector("[data-nombre=\"Monto\"]");
                    if (inputCant && inputCosto && inputMonto) {
                        function updateMonto() {
                            var rawC = (inputCant.value != null ? String(inputCant.value) : "").trim();
                            var rawP = (inputCosto.value != null ? String(inputCosto.value) : (inputCosto.textContent != null ? String(inputCosto.textContent) : "")).trim();
                            function toNum(s) { return parseFloat(String(s).replace(",", ".").replace(/\s/g, "")) || 0; }
                            var c = toNum(rawC);
                            var p = toNum(rawP);
                            var decimales = (sheetConfig.formulas.Monto.decimales != null) ? sheetConfig.formulas.Monto.decimales : 2;
                            inputMonto.value = (c * p).toFixed(decimales);
                        }
                        inputCant.addEventListener("input", updateMonto);
                        inputCant.addEventListener("change", updateMonto);
                        inputCosto.addEventListener("input", updateMonto);
                        inputCosto.addEventListener("change", updateMonto);
                        updateMonto();
                    }
                }
                formEl.addEventListener("submit", function (e) {
                    e.preventDefault(); hideEditAlert();
                    var newRow = headers.map(function () { return ""; });
                    formEl.querySelectorAll("[data-header-index]").forEach(function (el) {
                        var idx = parseInt(el.getAttribute("data-header-index"), 10);
                        if (idx < 0 || idx >= newRow.length) return;
                        var val = el.value != null ? String(el.value).trim() : (el.textContent != null ? String(el.textContent).trim() : "");
                        var formato = el.getAttribute("data-formato-visual");
                        var dataDec = el.getAttribute("data-decimales");
                        var decimales = (dataDec !== null && dataDec !== "") ? parseInt(dataDec, 10) : null;
                        if (formato && (formato === "moneda" || formato === "numero" || formato === "porcentaje") && typeof window.normalizeNumeroParaEnvio === "function") {
                            val = window.normalizeNumeroParaEnvio(val, formato, decimales != null ? decimales : 2);
                        } else if (formato && typeof window.parseNumeroVisual === "function") {
                            val = window.parseNumeroVisual(val, formato) || val;
                        }
                        newRow[idx] = val;
                    });
                    if (window.GENERAR_ID_PARA_HOJA && sheetConfig.clavePrimaria && sheetConfig.clavePrimaria[0]) { var idColIdx = headers.indexOf(sheetConfig.clavePrimaria[0]); if (idColIdx >= 0) newRow[idColIdx] = window.GENERAR_ID_PARA_HOJA(sheetConfig); }
                    var saveBtn = formEl.querySelector(".costos-edit-btn-save"); var btnText = saveBtn ? saveBtn.innerHTML : "";
                    if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = "<i class=\"fa-solid fa-spinner fa-spin\" aria-hidden=\"true\"></i> Guardando…"; }
                    if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.show("Guardando…");
                    var body = { action: "create", sheet: nombreHoja };
                    for (var k = 0; k < headers.length; k++) { if (headers[k]) body[headers[k]] = newRow[k] != null ? newRow[k] : ""; }
                    var formBody = new URLSearchParams();
                    for (var key in body) { if (body.hasOwnProperty(key)) formBody.append(key, body[key] != null ? body[key] : ""); }
                    fetch(appsScriptUrl, { method: "POST", body: formBody }).then(function (res) { return res.text(); }).then(function (text) {
                        var json; try { json = JSON.parse(text); } catch (err) { throw new Error("Respuesta no válida"); } return json;
                    }).then(function (json) {
                        if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = btnText; }
                        hideEditAlert();
                        if (!json || !json.success) {
                            showEditAlert("Error al guardar: " + ((json && json.error) ? json.error : "Respuesta inválida"), "error");
                            return Promise.reject(new Error(json && json.error ? json.error : "Error al guardar"));
                        }
                        var idElabIdx = headers.indexOf("IDElaboracion-ProductoBase");
                        var montoIdx = headers.indexOf("Monto");
                        var datosProducto = null;
                        try { var raw = sessionStorage.getItem("productoUnitarioBaseParaElaboracion"); if (raw) datosProducto = JSON.parse(raw); } catch (e) {}
                        if (datosProducto && datosProducto.id != null && idElabIdx >= 0 && montoIdx >= 0) {
                            var idProductoUnitario = String(datosProducto.id);
                            var bodyUpdate = {
                                action: "update",
                                sheet: "Tabla-Costos-ProductoUnitario",
                                id: idProductoUnitario,
                                "IDElaboracion-ProductoBase": (newRow[idElabIdx] != null ? String(newRow[idElabIdx]) : "").trim(),
                                "Costo-Produccion": (newRow[montoIdx] != null ? String(newRow[montoIdx]) : "").trim()
                            };
                            var formBodyUpdate = new URLSearchParams();
                            for (var k in bodyUpdate) { if (bodyUpdate.hasOwnProperty(k)) formBodyUpdate.append(k, bodyUpdate[k] != null ? bodyUpdate[k] : ""); }
                            return fetch(appsScriptUrl, { method: "POST", body: formBodyUpdate }).then(function (res) { return res.text(); }).then(function (text) {
                                var j; try { j = JSON.parse(text); } catch (err) { return { success: false, error: text }; } return j;
                            }).then(function (updateJson) {
                                if (!updateJson || !updateJson.success) {
                                    showEditAlert("Elaboración guardada. No se pudo vincular al producto unitario: " + (updateJson && updateJson.error ? updateJson.error : "Error"), "error");
                                }
                                try {
                                    sessionStorage.setItem("elaboracionProductoBaseRecienCreado", JSON.stringify({ headers: headers, row: newRow }));
                                    var headersProd = (datosProducto.headers || []).slice();
                                    var rowForEdit = (datosProducto.row || []).slice();
                                    var idxElab = headersProd.indexOf("IDElaboracion-ProductoBase");
                                    var idxCosto = headersProd.indexOf("Costo-Produccion");
                                    if (idxCosto < 0) idxCosto = headersProd.indexOf("Costo-Produccion-ProductoBase");
                                    if (idxElab >= 0) rowForEdit[idxElab] = (newRow[idElabIdx] != null ? String(newRow[idElabIdx]) : "").trim();
                                    if (idxCosto >= 0) rowForEdit[idxCosto] = (newRow[montoIdx] != null ? String(newRow[montoIdx]) : "").trim();
                                    sessionStorage.setItem("costosEditRecordProductoUnitarioBase", JSON.stringify({ id: datosProducto.id, headers: headersProd, row: rowForEdit }));
                                    sessionStorage.removeItem("productoUnitarioBaseParaElaboracion");
                                } catch (e) {}
                                window.location.replace("../Producto-Unitario-Base/editar-producto-unitario-base.html");
                            });
                        }
                        try {
                            sessionStorage.setItem("elaboracionProductoBaseRecienCreado", JSON.stringify({ headers: headers, row: newRow }));
                            sessionStorage.removeItem("productoUnitarioBaseParaElaboracion");
                        } catch (e) {}
                        window.location.replace("elaboracion-productos-base.html");
                        return Promise.resolve();
                    }).catch(function (err) {
                        if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = btnText; }
                        showEditAlert("Error: " + (err.message || ""), "error");
                    }).finally(function () { if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.hide(); });
                });
            }).catch(function (err) { loadingEl.style.display = "none"; noDataEl.style.display = "block"; noDataEl.textContent = "Error: " + (err.message || ""); });
        })();
    </script>
</body>
</html>
