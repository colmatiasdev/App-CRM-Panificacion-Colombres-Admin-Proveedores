<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ver costo producto - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../costos/costos.css">
    <script src="../../Arquitectura/config.js"></script>
    <script src="../../Arquitectura/config-sheets.js"></script>
    <script src="../../Arquitectura/sheets/costo-productos/costo-productos-sheets-base.js"></script>
    <script src="../../Arquitectura/sheets/costo-productos/sheets-ver-costo-productos.config.js"></script>
    <script>window.COSTO_PRODUCTOS_ACCION_ACTUAL = "ver";</script>
</head>
<body class="costos-page">
    <nav class="costos-nav" aria-label="Navegación principal">
        <a href="../../../index.html" class="costos-nav-link">Inicio</a>
        <a href="../armador-productos.html" class="costos-nav-link">Armador de Productos</a>
        <a href="../Productos-Elaborados/productos-elaborados.html" class="costos-nav-link">Lista de Productos Elaborados</a>
        <a href="costo-productos.html" class="costos-nav-link" data-accion="listar">Costo productos</a>
    </nav>
    <main class="costos-main">
        <h1 class="costos-title costos-title--con-icono"><i class="fa-solid fa-eye costos-title-icono" aria-hidden="true"></i> Ver costo producto</h1>
        <p class="costos-intro">Datos del registro. Solo visualización.</p>
        <div id="ver-container" class="costos-datos">
            <p id="ver-no-data" class="costos-placeholder" style="display:none;">No hay datos del registro. Volvé al listado y usá «Ver» en una tarjeta.</p>
            <p id="ver-loading" class="costos-placeholder">Cargando…</p>
            <div id="ver-detalle" class="costos-ver-detalle" style="display:none;"></div>
            <div id="ver-relacion-actions" class="costos-ver-relacion-actions" style="display:none;"></div>
            <div id="ver-actions" class="costos-edit-actions" style="display:none;">
                <a href="costo-productos.html" class="costos-edit-btn-cancel">Volver al listado</a>
                <a href="editar-costo-producto.html" id="ver-btn-editar" class="costos-edit-btn-editar"><i class="fa-solid fa-pen" aria-hidden="true"></i> Editar</a>
            </div>
        </div>
    </main>
    <script src="../../Arquitectura/sheets/costo-productos/costo-productos-config.js"></script>
    <script>if (window.COSTO_PRODUCTOS_APPLY_NAV) window.COSTO_PRODUCTOS_APPLY_NAV();</script>
    <script>
        (function () {
            var STORAGE_EDIT = "costosEditRecordCostoProductos";
            function norm(s) {
                return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, "").replace(/-/g, "");
            }
            function mapRowToConfigOrder(rowFromStorage, headersFromStorage, columnas) {
                var configNombres = columnas.map(function (c) { return c.nombre; });
                var out = [];
                for (var i = 0; i < configNombres.length; i++) {
                    var nombre = configNombres[i];
                    var idx = -1;
                    for (var j = 0; j < headersFromStorage.length; j++) {
                        if (norm(headersFromStorage[j]) === norm(nombre)) { idx = j; break; }
                    }
                    out.push(idx >= 0 ? (rowFromStorage[idx] != null ? String(rowFromStorage[idx]) : "") : "");
                }
                return out;
            }
            function escapeHtml(text) {
                if (text == null) return "";
                return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            }

            var noDataEl = document.getElementById("ver-no-data");
            var loadingEl = document.getElementById("ver-loading");
            var detalleEl = document.getElementById("ver-detalle");
            var relacionActionsEl = document.getElementById("ver-relacion-actions");
            var actionsEl = document.getElementById("ver-actions");

            function renderBotonesRelacion(row, columnas, pkColumna) {
                if (!relacionActionsEl) return;
                var base = window.COSTO_PRODUCTOS_SHEET_BASE;
                var hoja = base && base.hoja;
                var refs = hoja && hoja.referenciadoPor;
                if (!refs || !Array.isArray(refs) || refs.length === 0) {
                    relacionActionsEl.style.display = "none";
                    return;
                }
                var idxPk = -1;
                columnas.forEach(function (c, i) {
                    if (c.nombre === pkColumna) idxPk = i;
                });
                if (idxPk < 0) {
                    relacionActionsEl.style.display = "none";
                    return;
                }
                var idActual = row[idxPk] != null ? String(row[idxPk]).trim() : "";
                if (!idActual) {
                    relacionActionsEl.style.display = "none";
                    return;
                }
                var html = "";
                refs.forEach(function (ref) {
                    var card = (ref.cardinalidad || "").toString().toLowerCase();
                    var etiqueta = (card === "1:n")
                        ? (ref.etiquetaBoton1aN || "Ver registros asignados")
                        : (ref.etiquetaBoton1a1 || "Asignar");
                    var parts = [];
                    if (ref.parametroFiltroId) parts.push(ref.parametroFiltroId + "=" + encodeURIComponent(idActual));
                    if (card === "1:1" && ref.parametroModoAsignar) parts.push(ref.parametroModoAsignar + "=1");
                    var url = (ref.urlListado || "#") + (parts.length ? "?" + parts.join("&") : "");
                    html += "<a href=\"" + escapeHtml(url) + "\" class=\"costos-calc-btn costos-ver-btn-relacion\"><i class=\"fa-solid fa-link\" aria-hidden=\"true\"></i> " + escapeHtml(etiqueta) + "</a>";
                });
                if (html) {
                    relacionActionsEl.innerHTML = html;
                    relacionActionsEl.style.display = "flex";
                } else {
                    relacionActionsEl.style.display = "none";
                }
            }

            function getParamsFromUrl() {
                var p = {};
                var q = (window.location.search || "").replace(/^\?/, "").split("&");
                for (var i = 0; i < q.length; i++) {
                    var kv = q[i].split("=");
                    if (kv[0]) p[decodeURIComponent(kv[0])] = kv.length > 1 ? decodeURIComponent((kv.slice(1).join("=")).replace(/\+/g, " ")) : "";
                }
                return p;
            }

            function renderDetalle(sheetConfig, data) {
                var columnas = sheetConfig.columnas || [];
                var headers = data.headers || [];
                var rowFromStorage = data.row || [];
                var row = mapRowToConfigOrder(rowFromStorage, headers, columnas);
                if (row.length !== (columnas.map(function (c) { return c.nombre; })).length) {
                    row = headers.map(function (_, i) { return rowFromStorage[i] != null ? String(rowFromStorage[i]) : ""; });
                }
                loadingEl.style.display = "none";
                noDataEl.style.display = "none";
                detalleEl.style.display = "block";
                actionsEl.style.display = "flex";
                var html = "<dl class=\"costos-ver-dl\">";
                columnas.forEach(function (col, idx) {
                    var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                    if (!nombre) return;
                    if (col.visible === false) return;
                    var val = row[idx] != null ? String(row[idx]).trim() : "—";
                    html += "<dt class=\"costos-ver-dt\">" + escapeHtml(nombre) + "</dt>";
                    html += "<dd class=\"costos-ver-dd\">" + escapeHtml(val) + "</dd>";
                });
                html += "</dl>";
                detalleEl.innerHTML = html;
                var base = window.COSTO_PRODUCTOS_SHEET_BASE;
                var pkColumna = (base && base.hoja && base.hoja.clavePrimaria && base.hoja.clavePrimaria[0]) ? base.hoja.clavePrimaria[0] : "IDCosto-Producto";
                renderBotonesRelacion(row, columnas, pkColumna);
            }

            var raw = sessionStorage.getItem(STORAGE_EDIT);
            var urlParams = getParamsFromUrl();
            var idFromUrl = (urlParams.id || "").trim();

            if (raw) {
                var loadConfig = window.COSTO_PRODUCTOS_LOAD_CONFIG;
                if (!loadConfig) {
                    loadingEl.style.display = "none";
                    noDataEl.style.display = "block";
                    noDataEl.textContent = "No se pudo cargar la configuración del módulo.";
                } else {
                    loadConfig().then(function (sheetConfig) {
                        var data;
                        try { data = JSON.parse(raw); } catch (e) { data = {}; }
                        renderDetalle(sheetConfig, { headers: data.headers || [], row: data.row || [] });
                    }).catch(function (err) {
                        loadingEl.style.display = "none";
                        noDataEl.style.display = "block";
                        noDataEl.textContent = "Error al cargar configuración: " + (err.message || "");
                    });
                }
            } else if (idFromUrl) {
                var loadConfig = window.COSTO_PRODUCTOS_LOAD_CONFIG;
                if (!loadConfig) {
                    loadingEl.style.display = "none";
                    noDataEl.style.display = "block";
                    noDataEl.textContent = "No se pudo cargar la configuración del módulo.";
                } else {
                    var config = window.APP_CONFIG || {};
                    var appsScriptUrl = (config.appsScriptUrl || "").trim();
                    if (!appsScriptUrl) {
                        loadingEl.style.display = "none";
                        noDataEl.style.display = "block";
                        noDataEl.textContent = "No se configuró la URL del servidor.";
                    } else {
                        loadingEl.textContent = "Cargando costo producto…";
                        loadConfig().then(function (sheetConfig) {
                            var urlGet = appsScriptUrl + "?action=get&sheet=Tabla-Costo-Productos&id=" + encodeURIComponent(idFromUrl);
                            return fetch(urlGet, { cache: "no-store" }).then(function (r) { return r.json(); }).then(function (resp) {
                                if (!resp || !resp.success || !resp.data) {
                                    loadingEl.style.display = "none";
                                    noDataEl.style.display = "block";
                                    noDataEl.textContent = "No se encontró el costo producto.";
                                    return null;
                                }
                                var columnas = sheetConfig.columnas || [];
                                var headers = columnas.map(function (c) { return c.nombre; });
                                var row = headers.map(function (h) { return (resp.data[h] != null && resp.data[h] !== "") ? String(resp.data[h]).trim() : ""; });
                                sessionStorage.setItem(STORAGE_EDIT, JSON.stringify({ id: idFromUrl, headers: headers, row: row }));
                                if (window.history && window.history.replaceState) {
                                    window.history.replaceState({}, "", "ver-costo-producto.html");
                                }
                                return { sheetConfig: sheetConfig, data: { headers: headers, row: row } };
                            });
                        }).then(function (payload) {
                            if (payload) renderDetalle(payload.sheetConfig, payload.data);
                        }).catch(function (err) {
                            loadingEl.style.display = "none";
                            noDataEl.style.display = "block";
                            noDataEl.textContent = "Error al cargar: " + (err.message || "");
                        });
                    }
                }
            } else {
                loadingEl.style.display = "none";
                noDataEl.style.display = "block";
            }
        })();
    </script>
</body>
</html>
