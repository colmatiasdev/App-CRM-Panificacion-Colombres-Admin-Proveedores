<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Crear costo producto - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../costos/costos.css">
    <script src="../../Arquitectura/config.js"></script>
    <script src="../../Arquitectura/config-sheets.js"></script>
    <script src="../../Arquitectura/generar-id.js"></script>
    <script src="../../Arquitectura/sheets/costo-productos/costo-productos-sheets-base.js"></script>
    <script src="../../Arquitectura/sheets/costo-productos/sheets-crear-costo-productos.config.js"></script>
    <script>window.COSTO_PRODUCTOS_ACCION_ACTUAL = "crear";</script>
</head>
<body class="costos-page">
    <nav class="costos-nav" aria-label="Navegación principal">
        <a href="../../../index.html" class="costos-nav-link">Inicio</a>
        <a href="../armador-productos.html" class="costos-nav-link">Armador de Productos</a>
        <a href="../Productos-Elaborados/productos-elaborados.html" class="costos-nav-link">Lista de Productos Elaborados</a>
        <a href="costo-productos.html" class="costos-nav-link" data-accion="listar">Costo productos</a>
    </nav>
    <main class="costos-main">
        <h1 class="costos-title">Crear costo producto</h1>
        <p class="costos-intro">Completá los datos según la estructura de la hoja <strong>Tabla-Costo-Productos</strong>.</p>
        <div id="edit-form-container" class="costos-datos">
            <div id="costos-edit-alert" class="costos-alert" role="alert" aria-live="polite" style="display:none;"></div>
            <p id="edit-no-data" class="costos-placeholder" style="display:none;">No se pudo cargar el formulario. Revisá que existan costo-productos-sheets-base.js y sheets-crear-costo-productos.config.js.</p>
            <p id="edit-loading" class="costos-placeholder">Cargando formulario…</p>
            <form id="costos-edit-form" class="costos-edit-form" style="display:none;">
                <div id="edit-fields"></div>
                <div class="costos-edit-actions">
                    <a href="costo-productos.html" class="costos-edit-btn-cancel">Volver al listado</a>
                    <button type="submit" class="costos-edit-btn-save" id="costos-edit-btn-save"><i class="fa-solid fa-plus" aria-hidden="true"></i> Crear</button>
                </div>
            </form>
        </div>
    </main>
    <script src="../../Arquitectura/sheets/costo-productos/costo-productos-config.js"></script>
    <script>if (window.COSTO_PRODUCTOS_APPLY_NAV) window.COSTO_PRODUCTOS_APPLY_NAV();</script>
    <script>
        (function () {
            var STORAGE_EDIT = "costosEditRecordCostoProductos";
            var config = window.APP_CONFIG || {};
            var appsScriptUrl = (config.appsScriptUrl || "").trim();

            function norm(s) {
                return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, "").replace(/-/g, "");
            }

            function isClavePrimaria(nombre, clavePrimaria) {
                var n = norm(nombre);
                for (var i = 0; i < (clavePrimaria || []).length; i++) {
                    if (norm(clavePrimaria[i]) === n) return true;
                }
                return false;
            }

            var noDataEl = document.getElementById("edit-no-data");
            var loadingEl = document.getElementById("edit-loading");
            var formEl = document.getElementById("costos-edit-form");
            var fieldsContainer = document.getElementById("edit-fields");
            var alertEl = document.getElementById("costos-edit-alert");

            function showEditAlert(message, type) {
                if (!alertEl) return;
                alertEl.textContent = message || "";
                alertEl.className = "costos-alert costos-alert--" + (type === "success" ? "success" : "error");
                alertEl.style.display = message ? "block" : "none";
            }
            function hideEditAlert() {
                if (alertEl) { alertEl.style.display = "none"; alertEl.textContent = ""; alertEl.className = "costos-alert"; }
            }

            /**
             * Precalcula el siguiente valor para la columna con autogeneradorID (columnaOrden).
             */
            function ensureOrdenPreview(sheetConfig, url) {
                var nombreHoja = sheetConfig && sheetConfig.nombreHoja;
                if (!url || !nombreHoja) return Promise.resolve();
                if (sheetConfig._ordenPreview != null) return Promise.resolve();
                return fetch(url + "?action=list&sheet=" + encodeURIComponent(nombreHoja) + "&limit=10000&_=" + Date.now(), { cache: "no-store" })
                    .then(function (res) { return res.json(); })
                    .then(function (json) {
                        var headers = (json && json.data && json.data.headers) ? json.data.headers : [];
                        var rows = (json && json.data && json.data.rows) ? json.data.rows : [];
                        var colOrden = (sheetConfig.columnaOrden && String(sheetConfig.columnaOrden).trim()) || "";
                        if (colOrden) {
                            var idxColOrden = -1;
                            for (var i = 0; i < headers.length; i++) {
                                if (norm(String(headers[i] || "")) === norm(colOrden)) { idxColOrden = i; break; }
                            }
                            var maxVal = 0;
                            if (idxColOrden >= 0) {
                                for (var j = 0; j < rows.length; j++) {
                                    var r = rows[j];
                                    var val = Array.isArray(r) ? r[idxColOrden] : (r && headers[idxColOrden] != null ? r[headers[idxColOrden]] : null);
                                    var num = (val != null && val !== "") ? parseFloat(String(val), 10) : NaN;
                                    if (!isNaN(num) && num > maxVal) maxVal = num;
                                }
                            }
                            sheetConfig._ordenPreview = String(maxVal + 1);
                        } else {
                            sheetConfig._ordenPreview = "1";
                        }
                    })
                    .catch(function () {
                        if (sheetConfig) sheetConfig._ordenPreview = "1";
                    });
            }

            /**
             * Carga los combos declarados como tabla.nombreColumna en comboListadoValores.
             * Obtiene la hoja por API y guarda en window["COMPONENTE-COMBOS"][ref] los valores únicos de la columna.
             */
            function ensureCombosFromColumnas(url, columnas) {
                if (!url) return Promise.resolve();
                var refs = {};
                (columnas || []).forEach(function (col) {
                    var ref = col.comboListadoValores;
                    if (ref != null && typeof ref === "string") {
                        var refTrim = String(ref).trim();
                        var dot = refTrim.indexOf(".");
                        if (dot > 0) {
                            var parte1 = refTrim.substring(0, dot);
                            if (parte1 !== "COMPONENTE-COMBOS") refs[refTrim] = true;
                        }
                    }
                });
                var refList = Object.keys(refs);
                if (refList.length === 0) return Promise.resolve();
                var promesas = refList.map(function (ref) {
                    var parts = ref.split(".");
                    var hoja = parts[0];
                    var columna = parts.slice(1).join(".");
                    if (!hoja || !columna) return Promise.resolve();
                    return fetch(url + "?action=list&sheet=" + encodeURIComponent(hoja) + "&limit=10000&_=" + Date.now(), { cache: "no-store" })
                        .then(function (res) { return res.json(); })
                        .then(function (json) {
                            var headers = (json && json.data && json.data.headers) ? json.data.headers : [];
                            var rows = (json && json.data && json.data.rows) ? json.data.rows : [];
                            var idxCol = -1;
                            for (var h = 0; h < headers.length; h++) {
                                if (norm(String(headers[h] || "")) === norm(columna)) { idxCol = h; break; }
                            }
                            var unicos = {};
                            if (idxCol >= 0) {
                                for (var r = 0; r < rows.length; r++) {
                                    var row = rows[r];
                                    var v = Array.isArray(row) ? row[idxCol] : (row && headers[idxCol] != null ? row[headers[idxCol]] : null);
                                    var s = (v != null && String(v).trim() !== "") ? String(v).trim() : null;
                                    if (s != null) unicos[s] = true;
                                }
                            }
                            if (!window["COMPONENTE-COMBOS"]) window["COMPONENTE-COMBOS"] = {};
                            window["COMPONENTE-COMBOS"][ref] = Object.keys(unicos).sort();
                        })
                        .catch(function () {
                            if (!window["COMPONENTE-COMBOS"]) window["COMPONENTE-COMBOS"] = {};
                            window["COMPONENTE-COMBOS"][ref] = [];
                        });
                });
                return Promise.all(promesas);
            }

            /** Resuelve comboListadoValores a array de opciones: COMPONENTE-COMBOS.X o tabla.columna. */
            function getValoresCombo(ref) {
                if (ref == null || typeof ref !== "string") return [];
                var refTrim = String(ref).trim();
                if (refTrim.indexOf("COMPONENTE-COMBOS.") === 0) {
                    var key = refTrim.substring("COMPONENTE-COMBOS.".length);
                    return (window["COMPONENTE-COMBOS"] && window["COMPONENTE-COMBOS"][key] && Array.isArray(window["COMPONENTE-COMBOS"][key])) ? window["COMPONENTE-COMBOS"][key] : [];
                }
                return (window["COMPONENTE-COMBOS"] && window["COMPONENTE-COMBOS"][refTrim] && Array.isArray(window["COMPONENTE-COMBOS"][refTrim])) ? window["COMPONENTE-COMBOS"][refTrim] : [];
            }

            /** Construye la leyenda de una fórmula: operación y campos involucrados. */
            function buildFormulaLeyenda(formulaCol, columnas) {
                if (!formulaCol || !Array.isArray(formulaCol.fuentes) || formulaCol.fuentes.length === 0) return "";
                var op = (formulaCol.operacion || "").toLowerCase();
                var opLabel = { suma: "Suma", resta: "Resta", multiplicacion: "Multiplicación", division: "División", porcentaje: "Porcentaje" }[op] || op || "Cálculo";
                var nombres = formulaCol.fuentes.map(function (nombreCol) {
                    var c = columnas.filter(function (col) { return (col.nombre || "") === nombreCol; })[0];
                    return (c && (c.alias != null ? c.alias : c.nombre)) ? String(c.alias || c.nombre).trim() : nombreCol;
                });
                return opLabel + " de: " + nombres.join(", ");
            }

            if (!appsScriptUrl) {
                loadingEl.style.display = "none";
                noDataEl.style.display = "block";
                noDataEl.textContent = "No está configurada la URL de la API (appsScriptUrl en config.js).";
            } else {
                var loadConfig = window.COSTO_PRODUCTOS_LOAD_CONFIG;
                if (!loadConfig) {
                    loadingEl.style.display = "none";
                    noDataEl.style.display = "block";
                    noDataEl.textContent = "No se pudo cargar la configuración del módulo.";
                    return;
                }
                loadConfig().then(function (sheetConfig) {
                    return Promise.all([
                        ensureOrdenPreview(sheetConfig, appsScriptUrl),
                        ensureCombosFromColumnas(appsScriptUrl, sheetConfig.columnas)
                    ]).then(function () { return sheetConfig; });
                }).then(function (sheetConfig) {
                    var nombreHoja = sheetConfig.nombreHoja;
                    var clavePrimaria = sheetConfig.clavePrimaria || [];
                    var columnas = sheetConfig.columnas || [];
                    loadingEl.style.display = "none";
                    formEl.style.display = "block";
                    fieldsContainer.innerHTML = "";
                    var headers = columnas.map(function (c) { return c.nombre; });
                    var idGeneradoPreview = (window.GENERAR_ID_PARA_HOJA && sheetConfig.clavePrimaria && sheetConfig.clavePrimaria[0]) ? window.GENERAR_ID_PARA_HOJA(sheetConfig) : "";
                    columnas.forEach(function (col, idx) {
                        var nombre = (col.alias != null ? col.alias : col.nombre || "").trim();
                        if (!nombre) return;
                        if (col.visible === false) return;
                        var restr = col.restricciones || {};
                        var tipoComp = col.tipoComponente != null ? col.tipoComponente : col.tipo;
                        var tipoDato = col.tipoDato != null ? col.tipoDato : col.tipo;
                        var label = document.createElement("label");
                        label.className = "costos-edit-label";
                        label.setAttribute("for", "field-" + idx);
                        label.textContent = nombre;
                        var wrap = document.createElement("div");
                        wrap.className = "costos-edit-field";
                        wrap.appendChild(label);
                        if (tipoComp === "label") {
                            var valorMostrar = "";
                            var formulaCol = sheetConfig.formulas && sheetConfig.formulas[col.nombre];
                            var esFormula = formulaCol && formulaCol.fuentes && formulaCol.fuentes.length > 0 && formulaCol.expresion;
                            if (esFormula) {
                                valorMostrar = "0";
                            } else if (isClavePrimaria(col.nombre, clavePrimaria) && idGeneradoPreview) {
                                valorMostrar = idGeneradoPreview;
                            } else if (col.autogeneradorID === true && sheetConfig.columnaOrden && String(col.nombre || "").trim() === String(sheetConfig.columnaOrden).trim() && sheetConfig._ordenPreview != null) {
                                valorMostrar = sheetConfig._ordenPreview;
                            } else {
                                valorMostrar = col.descripcion || "Solo lectura";
                            }
                            var ro = document.createElement("span");
                            ro.id = "field-" + idx;
                            ro.className = "costos-edit-input costos-edit-readonly";
                            ro.setAttribute("data-header-index", String(idx));
                            ro.setAttribute("data-nombre", col.nombre);
                            ro.setAttribute("aria-readonly", "true");
                            if (esFormula) {
                                ro.setAttribute("data-formula-expresion", formulaCol.expresion);
                                ro.setAttribute("data-formula-decimales", String(formulaCol.decimales != null ? formulaCol.decimales : 2));
                                ro.setAttribute("data-formula-fuentes", JSON.stringify(formulaCol.fuentes));
                            }
                            ro.textContent = valorMostrar;
                            wrap.appendChild(ro);
                            if (esFormula) {
                                var leyenda = (formulaCol.leyenda != null && String(formulaCol.leyenda).trim() !== "") ? String(formulaCol.leyenda).trim() : buildFormulaLeyenda(formulaCol, columnas);
                                if (leyenda) {
                                    var leyendaEl = document.createElement("p");
                                    leyendaEl.className = "costos-edit-formula-leyenda";
                                    leyendaEl.setAttribute("aria-describedby", ro.id);
                                    leyendaEl.textContent = leyenda;
                                    wrap.appendChild(leyendaEl);
                                }
                            }
                        } else if (tipoComp === "combo-basico") {
                            var valoresCombo = [];
                            if (restr.valoresPermitidos && Array.isArray(restr.valoresPermitidos)) {
                                valoresCombo = restr.valoresPermitidos;
                            } else {
                                var ref = col.comboListadoValores;
                                if (Array.isArray(ref)) {
                                    valoresCombo = ref;
                                } else if (ref != null && typeof ref === "string") {
                                    valoresCombo = getValoresCombo(ref);
                                }
                            }
                            var select = document.createElement("select");
                            select.id = "field-" + idx;
                            select.className = "costos-edit-input";
                            select.setAttribute("data-header-index", String(idx));
                            select.setAttribute("data-nombre", col.nombre);
                            if (col.obligatorio !== true) {
                                var optVacio = document.createElement("option");
                                optVacio.value = "";
                                optVacio.textContent = "—";
                                select.appendChild(optVacio);
                            }
                            valoresCombo.forEach(function (v) {
                                var opt = document.createElement("option");
                                opt.value = (v != null ? String(v) : "");
                                opt.textContent = (v != null && v !== "") ? String(v) : "—";
                                select.appendChild(opt);
                            });
                            if (col.obligatorio === true) select.required = true;
                            wrap.appendChild(select);
                        } else if (tipoComp === "text-box" && (tipoDato === "numeric" || col.tipo === "numeric")) {
                            var input = document.createElement("input");
                            input.type = "number";
                            input.step = col.decimales != null ? (Math.pow(10, -col.decimales)) : "0.01";
                            if (restr.min != null) input.min = restr.min;
                            if (restr.max != null) input.max = restr.max;
                            input.id = "field-" + idx;
                            input.className = "costos-edit-input";
                            input.setAttribute("data-header-index", String(idx));
                            input.setAttribute("data-nombre", col.nombre);
                            input.placeholder = col.decimales ? "0.00" : "0";
                            if (col.obligatorio === true) input.required = true;
                            wrap.appendChild(input);
                        } else {
                            var input = document.createElement("input");
                            input.type = "text";
                            input.id = "field-" + idx;
                            input.className = "costos-edit-input";
                            input.setAttribute("data-header-index", String(idx));
                            input.setAttribute("data-nombre", col.nombre);
                            if (restr.maxLongitud) input.maxLength = restr.maxLongitud;
                            if (col.obligatorio === true) input.required = true;
                            wrap.appendChild(input);
                        }
                        fieldsContainer.appendChild(wrap);
                    });

                    function getFormValueByNombre(form, nombreColumna) {
                        var list = form.querySelectorAll("[data-nombre]");
                        for (var i = 0; i < list.length; i++) {
                            if (list[i].getAttribute("data-nombre") === nombreColumna) {
                                return (list[i].value != null ? String(list[i].value).trim() : String(list[i].textContent || "").trim());
                            }
                        }
                        return "";
                    }
                    function setFormValueByNombre(form, nombreColumna, value) {
                        var list = form.querySelectorAll("[data-nombre]");
                        for (var i = 0; i < list.length; i++) {
                            if (list[i].getAttribute("data-nombre") === nombreColumna) {
                                var str = (value != null && value !== "") ? String(value).trim() : "";
                                if (list[i].value !== undefined) list[i].value = str;
                                else list[i].textContent = str;
                                break;
                            }
                        }
                    }
                    function applyLookupsCostos(form, sheetConfig, apiUrl) {
                        if (!sheetConfig.lookups || sheetConfig.lookups.length === 0 || !apiUrl) return Promise.resolve();
                        var promesas = sheetConfig.lookups.map(function (lookup) {
                            var claveVal = getFormValueByNombre(form, lookup.columnaClaveLocal);
                            if (!claveVal) {
                                setFormValueByNombre(form, lookup.columnaDestino, "");
                                return Promise.resolve();
                            }
                            var url = apiUrl + "?action=get&sheet=" + encodeURIComponent(lookup.tablaOrigen) + "&id=" + encodeURIComponent(claveVal);
                            return fetch(url, { cache: "no-store" }).then(function (r) { return r.json(); }).then(function (resp) {
                                if (!resp || !resp.success || !resp.data) {
                                    setFormValueByNombre(form, lookup.columnaDestino, "");
                                    return;
                                }
                                var data = resp.data;
                                var val = (data[lookup.columnaOrigen] != null && data[lookup.columnaOrigen] !== "") ? data[lookup.columnaOrigen] : (data[lookup.columnaDestino] != null && data[lookup.columnaDestino] !== "" ? data[lookup.columnaDestino] : null);
                                var dec = (lookup.decimales != null) ? lookup.decimales : 2;
                                if (typeof val === "number" && !isNaN(val)) val = val.toFixed(dec);
                                else if (val != null && val !== "") val = String(val).trim();
                                else val = "";
                                setFormValueByNombre(form, lookup.columnaDestino, val);
                            }).catch(function () { setFormValueByNombre(form, lookup.columnaDestino, ""); });
                        });
                        return Promise.all(promesas);
                    }
                    function applyFormulasCostos(form) {
                        form.querySelectorAll("[data-formula-expresion]").forEach(function (span) {
                            var expr = span.getAttribute("data-formula-expresion");
                            var dec = parseInt(span.getAttribute("data-formula-decimales"), 10) || 2;
                            var fuentesJson = span.getAttribute("data-formula-fuentes");
                            if (!expr || !fuentesJson) return;
                            var fuentes;
                            try { fuentes = JSON.parse(fuentesJson); } catch (e) { return; }
                            if (!Array.isArray(fuentes)) return;
                            var exprEval = expr;
                            for (var i = 0; i < fuentes.length; i++) {
                                var letter = String.fromCharCode(97 + i);
                                var val = getFormValueByNombre(form, fuentes[i]);
                                var num = parseFloat(String(val).replace(",", ".")) || 0;
                                exprEval = exprEval.replace(new RegExp("\\b" + letter + "\\b", "g"), String(num));
                            }
                            var result;
                            try { result = Function("return (" + exprEval + ");")(); } catch (err) { result = 0; }
                            if (typeof result !== "number" || isNaN(result)) result = 0;
                            span.textContent = result.toFixed(dec);
                        });
                    }
                    var initialValuesCrear = {};
                    var checkFormChangesCrear = function () {};

                    applyFormulasCostos(formEl);
                    applyLookupsCostos(formEl, sheetConfig, appsScriptUrl);
                    formEl.querySelectorAll("input[data-nombre], select[data-nombre]").forEach(function (input) {
                        var nombre = input.getAttribute("data-nombre");
                        if (!nombre) return;
                        var esFuente = false;
                        if (sheetConfig.formulas) {
                            for (var k in sheetConfig.formulas) {
                                if (sheetConfig.formulas[k].fuentes && sheetConfig.formulas[k].fuentes.indexOf(nombre) !== -1) {
                                    esFuente = true;
                                    break;
                                }
                            }
                        }
                        if (esFuente) {
                            input.addEventListener("input", function () { applyFormulasCostos(formEl); checkFormChangesCrear(); });
                            input.addEventListener("change", function () { applyFormulasCostos(formEl); checkFormChangesCrear(); });
                        }
                        var esClaveLookup = false;
                        if (sheetConfig.lookups) {
                            for (var l = 0; l < sheetConfig.lookups.length; l++) {
                                if (sheetConfig.lookups[l].columnaClaveLocal === nombre) {
                                    esClaveLookup = true;
                                    break;
                                }
                            }
                        }
                        if (esClaveLookup) {
                            input.addEventListener("input", function () { applyLookupsCostos(formEl, sheetConfig, appsScriptUrl).then(checkFormChangesCrear); });
                            input.addEventListener("change", function () { applyLookupsCostos(formEl, sheetConfig, appsScriptUrl).then(checkFormChangesCrear); });
                        }
                    });

                    applyLookupsCostos(formEl, sheetConfig, appsScriptUrl).then(function () {
                        var saveBtn = formEl.querySelector(".costos-edit-btn-save");
                        (sheetConfig.valorAnterior || []).forEach(function (r) {
                            var v = getFormValueByNombre(formEl, r.columnaOrigen);
                            var actualDestino = getFormValueByNombre(formEl, r.columnaDestino);
                            if (actualDestino !== v) setFormValueByNombre(formEl, r.columnaDestino, v);
                        });
                        formEl.querySelectorAll("[data-nombre]").forEach(function (el) {
                            var n = el.getAttribute("data-nombre");
                            if (n) initialValuesCrear[n] = (el.value != null ? String(el.value) : String(el.textContent || "")).trim();
                        });
                        if (saveBtn) saveBtn.disabled = true;
                        checkFormChangesCrear = function () {
                            var has = false;
                            formEl.querySelectorAll("[data-nombre]").forEach(function (el) {
                                var n = el.getAttribute("data-nombre");
                                if (!n) return;
                                var cur = (el.value != null ? String(el.value) : String(el.textContent || "")).trim();
                                if (cur !== (initialValuesCrear[n] != null ? initialValuesCrear[n] : "")) has = true;
                            });
                            if (saveBtn) saveBtn.disabled = !has;
                        };
                        formEl.querySelectorAll("input[data-nombre], select[data-nombre]").forEach(function (input) {
                            input.addEventListener("input", checkFormChangesCrear);
                            input.addEventListener("change", checkFormChangesCrear);
                        });
                    });

                    formEl.addEventListener("submit", function (e) {
                        e.preventDefault();
                        hideEditAlert();
                        applyFormulasCostos(formEl);
                        applyLookupsCostos(formEl, sheetConfig, appsScriptUrl).then(function () {
                        var newRow = headers.map(function () { return ""; });
                        formEl.querySelectorAll("[data-header-index]").forEach(function (el) {
                            var idx = parseInt(el.getAttribute("data-header-index"), 10);
                            if (idx >= 0 && idx < newRow.length) {
                                var v = (el.value != null && el.value !== undefined) ? String(el.value).trim() : String((el.textContent != null ? el.textContent : "")).trim();
                                newRow[idx] = v;
                            }
                        });
                        if (window.GENERAR_ID_PARA_HOJA && sheetConfig.clavePrimaria && sheetConfig.clavePrimaria[0]) {
                            var idColNombre = sheetConfig.clavePrimaria[0];
                            var idColIdx = headers.indexOf(idColNombre);
                            if (idColIdx >= 0) {
                                newRow[idColIdx] = window.GENERAR_ID_PARA_HOJA(sheetConfig);
                            }
                        }
                        var saveBtn = formEl.querySelector(".costos-edit-btn-save");
                        var btnText = saveBtn ? saveBtn.innerHTML : "";
                        if (saveBtn) {
                            saveBtn.disabled = true;
                            saveBtn.innerHTML = "<i class=\"fa-solid fa-spinner fa-spin\" aria-hidden=\"true\"></i> Guardando…";
                        }
                        if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.show("Guardando…");
                        var columnaAutogen = sheetConfig.columnaOrden || null;
                        var colIdxAutogen = columnaAutogen ? headers.indexOf(columnaAutogen) : -1;
                        var promesaNewRow = (columnaAutogen && colIdxAutogen >= 0) ? fetch(appsScriptUrl + "?action=list&sheet=" + encodeURIComponent(nombreHoja) + "&limit=10000&_=" + Date.now(), { cache: "no-store" })
                            .then(function (res) { return res.json(); })
                            .then(function (json) {
                                var listHeaders = (json && json.data && json.data.headers) ? json.data.headers : [];
                                var listRows = (json && json.data && json.data.rows) ? json.data.rows : [];
                                var idxCol = -1;
                                for (var h = 0; h < listHeaders.length; h++) {
                                    if (String(listHeaders[h] || "").trim() === String(columnaAutogen).trim()) { idxCol = h; break; }
                                }
                                var maxVal = 0;
                                if (idxCol >= 0) {
                                    for (var r = 0; r < listRows.length; r++) {
                                        var row = listRows[r];
                                        var v = Array.isArray(row) ? row[idxCol] : (row && listHeaders[idxCol] != null ? row[listHeaders[idxCol]] : null);
                                        var num = (v != null && v !== "") ? parseFloat(String(v), 10) : NaN;
                                        if (!isNaN(num) && num > maxVal) maxVal = num;
                                    }
                                }
                                newRow[colIdxAutogen] = String(maxVal + 1);
                                return newRow;
                            })
                            .catch(function () { return newRow; }) : Promise.resolve(newRow);
                        promesaNewRow.then(function (rowFinal) {
                            var body = { action: "create", sheet: nombreHoja };
                            for (var k = 0; k < headers.length; k++) {
                                if (headers[k]) body[headers[k]] = rowFinal[k] != null ? rowFinal[k] : "";
                            }
                            var formBody = new URLSearchParams();
                            for (var key in body) {
                                if (body.hasOwnProperty(key)) formBody.append(key, body[key] != null ? body[key] : "");
                            }
                            return fetch(appsScriptUrl, { method: "POST", body: formBody });
                        })
                            .then(function (res) { return res.text(); })
                            .then(function (text) {
                                var json;
                                try { json = JSON.parse(text); } catch (err) {
                                    if (text && (text.trim().indexOf("<!DOCTYPE") === 0 || text.trim().indexOf("<html") === 0)) {
                                        throw new Error("El servidor respondió con HTML. Revisá que el Apps Script esté desplegado como aplicación web.");
                                    }
                                    throw new Error("Respuesta no válida: " + (text ? text.substring(0, 60) + "…" : "vacía"));
                                }
                                return json;
                            })
                            .then(function (json) {
                                if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = btnText; }
                                if (json && json.success) {
                                    window.location.replace("costo-productos.html");
                                } else {
                                    showEditAlert("Error al guardar: " + (json && json.error ? json.error : "Respuesta inválida"), "error");
                                }
                            })
                            .catch(function (err) {
                                if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = btnText; }
                                showEditAlert("Error de conexión: " + (err.message || "Revisá appsScriptUrl."), "error");
                            })
                            .finally(function () {
                                if (window.COSTOS_SPINNER) window.COSTOS_SPINNER.hide();
                            });
                        });
                    });
                }).catch(function (err) {
                    loadingEl.style.display = "none";
                    noDataEl.style.display = "block";
                    noDataEl.textContent = "Error al cargar configuración: " + (err.message || "Revisá el JSON de arquitectura.");
                });
            }
        })();
    </script>
</body>
</html>
