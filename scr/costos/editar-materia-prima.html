<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Editar materia prima - Panificación Colombres</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="costos.css">
    <script src="../../config.js"></script>
</head>
<body class="costos-page">
    <a href="materia-prima.html" class="costos-back"><span class="costos-back-arrow">←</span> Volver a Materia prima</a>
    <main class="costos-main">
        <h1 class="costos-title">Editar registro</h1>
        <p class="costos-intro">Datos del registro. Modifique el precio y guarde cuando termine.</p>
        <div id="edit-form-container" class="costos-datos">
            <p id="edit-no-data" class="costos-placeholder" style="display:none;">No hay datos del registro. Volvé a Materia prima y abrí «Editar» en una tarjeta.</p>
            <form id="costos-edit-form" class="costos-edit-form" style="display:none;">
                <div id="edit-fields"></div>
                <div class="costos-edit-actions">
                    <button type="submit" class="costos-edit-btn-save"><i class="fa-solid fa-check" aria-hidden="true"></i> Guardar cambios</button>
                </div>
            </form>
        </div>
    </main>
    <script>
        (function () {
            function normHeader(s) {
                return String(s != null ? s : "").trim().toLowerCase().replace(/\s+/g, " ").replace(/-/g, " ");
            }
            function normHeaderForCompare(s) {
                var n = normHeader(s);
                try {
                    return n.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                } catch (e) {
                    return n.replace(/[áàäâ]/gi, "a").replace(/[éèëê]/gi, "e").replace(/[íìïî]/gi, "i").replace(/[óòöô]/gi, "o").replace(/[úùüû]/gi, "u");
                }
            }
            function isPrecioEditable(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "precio" || n === "precio actual";
            }
            function isPrecioAnteriorColumn(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "precio anterior";
            }
            function isObservacionesColumn(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "observaciones";
            }
            function isFechaActualizadaColumn(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "fecha actualizada al" || n === "fecha actualizada";
            }
            function getTodayDate() {
                var d = new Date();
                var day = d.getDate();
                var month = d.getMonth() + 1;
                var year = d.getFullYear();
                return (day < 10 ? "0" : "") + day + "/" + (month < 10 ? "0" : "") + month + "/" + year;
            }
            function formatMonedaArg(val) {
                if (val == null || String(val).trim() === "") return "—";
                var s = String(val).trim().replace(",", ".");
                var n = parseFloat(s);
                if (isNaN(n)) return String(val);
                var parts = n.toFixed(2).split(".");
                var intPart = parts[0];
                var decPart = parts[1];
                var withDots = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return "$ " + withDots + "," + decPart;
            }
            function isPrecioDisplayField(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "precio anterior" || n === "precio costo x unidad" || n === "precio-costo-x-unidad"
                    || n === "precio equivalencia x unidad" || n === "precio-equivalencia-x-unidad"
                    || n === "precio" || n === "precio actual";
            }
            function isCalculatedField(nameNorm) {
                var n = (nameNorm || "").trim();
                return n === "cantidad unidad medida" || n === "cantidad-unidad-medida"
                    || n === "precio costo x unidad" || n === "precio-costo-x-unidad"
                    || n === "precio equivalencia x unidad" || n === "precio-equivalencia-x-unidad"
                    || n === "precio anterior"
                    || n === "fecha actualizada al" || n === "fecha actualizada";
            }

            var raw = sessionStorage.getItem("costosEditRecord");
            var params = new URLSearchParams(window.location.search);
            var idFromUrl = params.get("id") || "";

            var noDataEl = document.getElementById("edit-no-data");
            var formEl = document.getElementById("costos-edit-form");
            var fieldsContainer = document.getElementById("edit-fields");

            if (!raw) {
                noDataEl.style.display = "block";
                formEl.style.display = "none";
            } else {
                try {
                    var data = JSON.parse(raw);
                    var headers = data.headers || [];
                    var row = data.row || [];
                    var record = {};
                    for (var i = 0; i < headers.length; i++) {
                        var key = String(headers[i] != null ? headers[i] : "").trim();
                        var val = row[i];
                        record[key] = val != null ? String(val).trim() : "";
                    }

                    noDataEl.style.display = "none";
                    formEl.style.display = "block";

                    fieldsContainer.innerHTML = "";
                    var fechaActualizadaIdx = -1;
                    var precioActualKey = "";
                    for (var j = 0; j < headers.length; j++) {
                        if (isPrecioEditable(normHeader(headers[j]))) {
                            precioActualKey = String(headers[j] != null ? headers[j] : "").trim();
                            break;
                        }
                    }
                    var idxPresCant = -1, idxPresUnid = -1, idxPresTipo = -1;
                    var keyPresCant = "", keyPresUnid = "", keyPresTipo = "";
                    headers.forEach(function (h, idx) {
                        var n = normHeader(h);
                        var k = String(h != null ? h : "").trim();
                        if (n === "presentacion cantidad medida" || n === "presentacion-cantidad-medida") { idxPresCant = idx; keyPresCant = k; }
                        if (n === "presentacion unidad" || n === "presentacion-unidad") { idxPresUnid = idx; keyPresUnid = k; }
                        if (n === "presentacion tipo" || n === "presentacion-tipo") { idxPresTipo = idx; keyPresTipo = k; }
                    });
                    function buildPresentacionStr(cant, unid, tipo) {
                        var s = (String(cant).trim() + " " + String(unid).trim()).trim();
                        if (String(tipo).trim()) s += " [" + String(tipo).trim() + "]";
                        return s || "—";
                    }
                    var categoriaColIdx = -1;
                    for (var c = 0; c < headers.length; c++) {
                        var hNorm = normHeaderForCompare(headers[c]);
                        var hTrim = String(headers[c] != null ? headers[c] : "").trim().toLowerCase().replace(/\s/g, "");
                        if (hNorm === "categoria" || hTrim === "categoria" || hTrim === "categoría") {
                            categoriaColIdx = c;
                            break;
                        }
                    }
                    if (categoriaColIdx < 0 && headers.length > 1) {
                        categoriaColIdx = 1;
                    }
                    var marcaColIdx = -1;
                    var lugarColIdx = -1;
                    for (var m = 0; m < headers.length; m++) {
                        var hNormM = normHeaderForCompare(headers[m]);
                        var hTrimM = String(headers[m] != null ? headers[m] : "").trim().toLowerCase().replace(/\s/g, "");
                        if (hNormM === "marca" || hTrimM === "marca") { marcaColIdx = m; break; }
                    }
                    for (var l = 0; l < headers.length; l++) {
                        var hNormL = normHeaderForCompare(headers[l]);
                        var hTrimL = String(headers[l] != null ? headers[l] : "").trim().toLowerCase().replace(/\s/g, "");
                        if (hNormL === "lugar" || hTrimL === "lugar") { lugarColIdx = l; break; }
                    }
                    var categoriasForDatalist = [];
                    try {
                        var storedCat = sessionStorage.getItem("costosDistinctCategorias");
                        if (storedCat) categoriasForDatalist = JSON.parse(storedCat);
                    } catch (e) {}
                    var currentCatVal = "";
                    if (categoriaColIdx >= 0) {
                        currentCatVal = record[headers[categoriaColIdx]];
                        if (currentCatVal == null || String(currentCatVal).trim() === "") {
                            currentCatVal = (row[categoriaColIdx] != null ? String(row[categoriaColIdx]).trim() : "") || "";
                        } else {
                            currentCatVal = String(currentCatVal).trim();
                        }
                        if (categoriasForDatalist.length === 0 && currentCatVal) {
                            categoriasForDatalist = [currentCatVal];
                            try { sessionStorage.setItem("costosDistinctCategorias", JSON.stringify(categoriasForDatalist)); } catch (e) {}
                        }
                    }
                    var categoriasState = { list: categoriasForDatalist };
                    var marcasForDatalist = [];
                    try {
                        var storedMarca = sessionStorage.getItem("costosDistinctMarcas");
                        if (storedMarca) marcasForDatalist = JSON.parse(storedMarca);
                    } catch (e) {}
                    if (marcaColIdx >= 0 && marcasForDatalist.length === 0) {
                        var currentMarca = (record[headers[marcaColIdx]] != null ? String(record[headers[marcaColIdx]]).trim() : "") || (row[marcaColIdx] != null ? String(row[marcaColIdx]).trim() : "");
                        if (currentMarca) { marcasForDatalist = [currentMarca]; try { sessionStorage.setItem("costosDistinctMarcas", JSON.stringify(marcasForDatalist)); } catch (e) {} }
                    }
                    var lugaresForDatalist = [];
                    try {
                        var storedLugar = sessionStorage.getItem("costosDistinctLugares");
                        if (storedLugar) lugaresForDatalist = JSON.parse(storedLugar);
                    } catch (e) {}
                    if (lugarColIdx >= 0 && lugaresForDatalist.length === 0) {
                        var currentLugar = (record[headers[lugarColIdx]] != null ? String(record[headers[lugarColIdx]]).trim() : "") || (row[lugarColIdx] != null ? String(row[lugarColIdx]).trim() : "");
                        if (currentLugar) { lugaresForDatalist = [currentLugar]; try { sessionStorage.setItem("costosDistinctLugares", JSON.stringify(lugaresForDatalist)); } catch (e) {} }
                    }
                    var presentationRowAdded = false;
                    headers.forEach(function (headerName, i) {
                        var key = String(headerName != null ? headerName : "").trim();
                        var nameNorm = normHeader(headerName);
                        if (nameNorm === "habilitado") return;
                        if (nameNorm === "idmateria prima" || nameNorm === "idmateria-prima") return;
                        if (nameNorm === "presentacion cantidad medida" || nameNorm === "presentacion-cantidad-medida" || nameNorm === "presentacion unidad" || nameNorm === "presentacion-unidad" || nameNorm === "presentacion tipo" || nameNorm === "presentacion-tipo") {
                            if (!presentationRowAdded) {
                                var cantVal = record[keyPresCant] || "";
                                var unidVal = record[keyPresUnid] || "";
                                var tipoVal = record[keyPresTipo] || "";
                                var presStr = buildPresentacionStr(cantVal, unidVal, tipoVal);
                                var wrapPres = document.createElement("div");
                                wrapPres.className = "costos-edit-field costos-edit-field-presentacion";
                                var labelPres = document.createElement("span");
                                labelPres.className = "costos-edit-label";
                                labelPres.textContent = "PRESENTACIÓN";
                                var valueSpanPres = document.createElement("span");
                                valueSpanPres.className = "costos-edit-value costos-edit-value-presentacion";
                                valueSpanPres.textContent = presStr;
                                var valueCellPres = document.createElement("div");
                                valueCellPres.className = "costos-edit-value-cell";
                                valueCellPres.appendChild(valueSpanPres);
                                var editBtnPres = document.createElement("button");
                                editBtnPres.type = "button";
                                editBtnPres.className = "costos-edit-value-edit-btn";
                                editBtnPres.setAttribute("title", "Editar presentación");
                                editBtnPres.setAttribute("aria-label", "Editar presentación");
                                editBtnPres.innerHTML = "<i class=\"fa-solid fa-pen\" aria-hidden=\"true\"></i>";
                                valueCellPres.appendChild(editBtnPres);
                                editBtnPres.addEventListener("click", function () {
                                    var block = wrapPres.querySelector(".costos-edit-presentacion-inputs");
                                    if (block) {
                                        if (block.style.display !== "none") {
                                            block.style.display = "none";
                                            valueSpanPres.style.display = "";
                                            editBtnPres.style.display = "";
                                            var inpC = block.querySelector(".costos-edit-input[data-header-index=\"" + idxPresCant + "\"]");
                                            var inpU = block.querySelector(".costos-edit-input[data-header-index=\"" + idxPresUnid + "\"]");
                                            var inpT = block.querySelector(".costos-edit-input[data-header-index=\"" + idxPresTipo + "\"]");
                                            if (inpC && inpU && inpT) valueSpanPres.textContent = buildPresentacionStr(inpC.value, inpU.value, inpT.value);
                                        } else {
                                            block.style.display = "";
                                            valueSpanPres.style.display = "none";
                                            editBtnPres.style.display = "none";
                                            var firstInp = block.querySelector(".costos-edit-input");
                                            if (firstInp) firstInp.focus();
                                        }
                                        return;
                                    }
                                    var blockIn = document.createElement("div");
                                    blockIn.className = "costos-edit-presentacion-inputs";
                                    var closeRow = document.createElement("div");
                                    closeRow.className = "costos-edit-presentacion-close-row";
                                    var closeBtnPres = document.createElement("button");
                                    closeBtnPres.type = "button";
                                    closeBtnPres.className = "costos-edit-value-close-btn";
                                    closeBtnPres.setAttribute("title", "Cerrar sin guardar");
                                    closeBtnPres.setAttribute("aria-label", "Cerrar");
                                    closeBtnPres.innerHTML = "<i class=\"fa-solid fa-xmark\" aria-hidden=\"true\"></i>";
                                    closeRow.appendChild(closeBtnPres);
                                    blockIn.appendChild(closeRow);
                                    var lblC = document.createElement("label");
                                    lblC.className = "costos-edit-presentacion-label";
                                    lblC.textContent = "Cantidad en paquete";
                                    var inpCant = document.createElement("input");
                                    inpCant.type = "text";
                                    inpCant.className = "costos-edit-input";
                                    inpCant.setAttribute("data-header-index", String(idxPresCant));
                                    inpCant.value = record[keyPresCant] || "";
                                    inpCant.placeholder = "Ej: 5";
                                    var lblU = document.createElement("label");
                                    lblU.className = "costos-edit-presentacion-label";
                                    lblU.textContent = "Unidad";
                                    var inpUnid = document.createElement("input");
                                    inpUnid.type = "text";
                                    inpUnid.className = "costos-edit-input";
                                    inpUnid.setAttribute("data-header-index", String(idxPresUnid));
                                    inpUnid.value = record[keyPresUnid] || "";
                                    inpUnid.placeholder = "Ej: Kg, L";
                                    var lblT = document.createElement("label");
                                    lblT.className = "costos-edit-presentacion-label";
                                    lblT.textContent = "Tipo presentación";
                                    var inpTipo = document.createElement("input");
                                    inpTipo.type = "text";
                                    inpTipo.className = "costos-edit-input";
                                    inpTipo.setAttribute("data-header-index", String(idxPresTipo));
                                    inpTipo.value = record[keyPresTipo] || "";
                                    inpTipo.placeholder = "Ej: Paquete, Bolsa";
                                    function updatePresLabel() {
                                        valueSpanPres.textContent = buildPresentacionStr(inpCant.value, inpUnid.value, inpTipo.value);
                                    }
                                    inpCant.addEventListener("input", updatePresLabel);
                                    inpCant.addEventListener("change", updatePresLabel);
                                    inpUnid.addEventListener("input", updatePresLabel);
                                    inpUnid.addEventListener("change", updatePresLabel);
                                    inpTipo.addEventListener("input", updatePresLabel);
                                    inpTipo.addEventListener("change", updatePresLabel);
                                    blockIn.appendChild(lblC);
                                    blockIn.appendChild(inpCant);
                                    blockIn.appendChild(lblU);
                                    blockIn.appendChild(inpUnid);
                                    blockIn.appendChild(lblT);
                                    blockIn.appendChild(inpTipo);
                                    closeBtnPres.addEventListener("click", function () {
                                        inpCant.value = record[keyPresCant] || "";
                                        inpUnid.value = record[keyPresUnid] || "";
                                        inpTipo.value = record[keyPresTipo] || "";
                                        valueSpanPres.textContent = buildPresentacionStr(record[keyPresCant], record[keyPresUnid], record[keyPresTipo]);
                                        blockIn.style.display = "none";
                                        valueSpanPres.style.display = "";
                                        editBtnPres.style.display = "";
                                    });
                                    wrapPres.appendChild(blockIn);
                                    valueSpanPres.style.display = "none";
                                    editBtnPres.style.display = "none";
                                    inpCant.focus();
                                });
                                wrapPres.appendChild(labelPres);
                                wrapPres.appendChild(valueCellPres);
                                fieldsContainer.appendChild(wrapPres);
                                presentationRowAdded = true;
                            }
                            return;
                        }

                        var value = record[key] || "";
                        if (isFechaActualizadaColumn(nameNorm)) {
                            value = getTodayDate();
                            fechaActualizadaIdx = i;
                        }
                        if (isPrecioAnteriorColumn(nameNorm) && precioActualKey) {
                            value = record[precioActualKey] || value;
                        }
                        var editable = isPrecioEditable(nameNorm);
                        var isObservaciones = isObservacionesColumn(nameNorm);

                        var wrap = document.createElement("div");
                        wrap.className = "costos-edit-field" + (editable ? " is-editable" : "") + (isObservaciones ? " is-textarea" : "");
                        wrap.setAttribute("data-header-index", String(i));
                        if (nameNorm === "cantidad unidad medida" || nameNorm === "cantidad-unidad-medida") wrap.setAttribute("data-field", "cantidad-unidad-medida");
                        if (nameNorm === "precio anterior") wrap.setAttribute("data-field", "precio-anterior");
                        if (nameNorm === "precio costo x unidad" || nameNorm === "precio-costo-x-unidad") wrap.setAttribute("data-field", "precio-costo-x-unidad");
                        if (nameNorm === "equivalencia unidad medida" || nameNorm === "equivalencia-unidad-medida") wrap.setAttribute("data-field", "equivalencia-unidad-medida");
                        if (nameNorm === "precio equivalencia x unidad" || nameNorm === "precio-equivalencia-x-unidad") wrap.setAttribute("data-field", "precio-equivalencia-x-unidad");

                        var labelWrap = document.createElement("span");
                        labelWrap.className = "costos-edit-label" + (isCalculatedField(nameNorm) ? " costos-edit-label-calc" : "");
                        var labelText = (nameNorm === "presentacion tipo" || nameNorm === "presentacion-tipo")
                            ? "Tipo de presentación (envoltorio del producto)"
                            : (nameNorm === "presentacion cantidad medida" || nameNorm === "presentacion-cantidad-medida")
                            ? "Cantidad que viene en el paquete del producto"
                            : (nameNorm === "presentacion unidad" || nameNorm === "presentacion-unidad")
                            ? "Unidad de medida de la cantidad del paquete (Kg, L, unidad, etc.)"
                            : (nameNorm === "equivalencia unidad medida" || nameNorm === "equivalencia-unidad-medida")
                            ? "Equivalencia (resultado de la calculadora de presentación según tipo de unidad de medida)"
                            : (nameNorm === "tipo unidad medida" || nameNorm === "tipo-unidad-medida")
                            ? "Tipo de unidad de medida (Gramos, Kg, L, etc.)"
                            : (nameNorm === "cantidad unidad medida" || nameNorm === "cantidad-unidad-medida")
                            ? "Cantidad unidad de medida (resultado de equivalencia: cantidad y unidad del paquete convertidas al tipo de unidad de medida; valor entero)"
                            : (nameNorm === "precio costo x unidad" || nameNorm === "precio-costo-x-unidad")
                            ? "Precio costo por unidad (Precio anterior ÷ Cantidad unidad de medida)"
                            : (key || "—");
                        var parenIdx = labelText.indexOf(" (");
                        if (parenIdx >= 0) {
                            var mainText = labelText.substring(0, parenIdx);
                            var descText = labelText.substring(parenIdx + 1);
                            var mainSpan = document.createElement("span");
                            mainSpan.className = "costos-edit-label-main";
                            mainSpan.textContent = mainText;
                            labelWrap.appendChild(mainSpan);
                            if (isCalculatedField(nameNorm)) {
                                var calcIcon = document.createElement("span");
                                calcIcon.className = "costos-edit-calc-icon";
                                calcIcon.setAttribute("title", "Campo calculado o con operación matemática");
                                calcIcon.setAttribute("aria-label", "Campo calculado");
                                calcIcon.innerHTML = "<i class=\"fa-solid fa-calculator\" aria-hidden=\"true\"></i>";
                                labelWrap.appendChild(calcIcon);
                            }
                            var descSpan = document.createElement("span");
                            descSpan.className = "costos-edit-label-desc";
                            descSpan.textContent = descText;
                            labelWrap.appendChild(descSpan);
                        } else {
                            labelWrap.textContent = labelText;
                            if (isCalculatedField(nameNorm)) {
                                var calcIconEnd = document.createElement("span");
                                calcIconEnd.className = "costos-edit-calc-icon";
                                calcIconEnd.setAttribute("title", "Campo calculado o con operación matemática");
                                calcIconEnd.setAttribute("aria-label", "Campo calculado");
                                calcIconEnd.innerHTML = "<i class=\"fa-solid fa-calculator\" aria-hidden=\"true\"></i>";
                                labelWrap.appendChild(calcIconEnd);
                            }
                        }
                        var label = labelWrap;

                        var displayValue = value || "—";
                        if (nameNorm === "cantidad unidad medida" || nameNorm === "cantidad-unidad-medida") {
                            var num = parseFloat(String(value).replace(",", "."));
                            if (!isNaN(num)) displayValue = String(Math.round(num));
                        } else if (isPrecioDisplayField(nameNorm)) {
                            displayValue = formatMonedaArg(value);
                        }
                        var valueSpan = document.createElement("span");
                        valueSpan.className = "costos-edit-value";
                        valueSpan.textContent = displayValue;

                        var valueCell = document.createElement("div");
                        valueCell.className = "costos-edit-value-cell";
                        valueCell.appendChild(valueSpan);
                        if (!editable && !isObservaciones && !isCalculatedField(nameNorm)) {
                            var editIcon = document.createElement("button");
                            editIcon.type = "button";
                            editIcon.className = "costos-edit-value-edit-btn";
                            editIcon.setAttribute("title", "Editar este campo");
                            editIcon.setAttribute("aria-label", "Editar campo");
                            editIcon.innerHTML = "<i class=\"fa-solid fa-pen\" aria-hidden=\"true\"></i>";
                            valueCell.appendChild(editIcon);
                            (function (w, cell, span, idx, rawVal, isCategoriaField, isMarcaField, isLugarField, form, categoriasStateRef) {
                                function removeDatalistCategoria() {
                                    var dl = document.getElementById("costos-datalist-categoria");
                                    if (dl) dl.parentNode.removeChild(dl);
                                }
                                editIcon.addEventListener("click", function () {
                                    var wrapCombo = cell.querySelector(".costos-edit-categoria-wrap, .costos-edit-marca-wrap, .costos-edit-lugar-wrap");
                                    var dyn = w.querySelector(".costos-edit-input-dynamic");
                                    if (wrapCombo) {
                                        var hidden = wrapCombo.querySelector("input[type=hidden].costos-edit-input");
                                        var val = hidden ? hidden.value : "";
                                        if (val === "__nueva__") val = "";
                                        span.textContent = (val || "").trim() || "—";
                                        span.style.display = "";
                                        wrapCombo.parentNode.removeChild(wrapCombo);
                                        var closeBtn = cell.querySelector(".costos-edit-value-close-btn");
                                        if (closeBtn) closeBtn.parentNode.removeChild(closeBtn);
                                        editIcon.style.display = "";
                                        return;
                                    }
                                    if (dyn) {
                                        span.textContent = dyn.value || "—";
                                        span.style.display = "";
                                        dyn.parentNode.removeChild(dyn);
                                        removeDatalistCategoria();
                                        var closeBtn = cell.querySelector(".costos-edit-value-close-btn");
                                        if (closeBtn) closeBtn.parentNode.removeChild(closeBtn);
                                        editIcon.style.display = "";
                                        return;
                                    }
                                    var inp;
                                    if (isCategoriaField && form) {
                                        var opts = [];
                                        try {
                                            var stored = sessionStorage.getItem("costosDistinctCategorias");
                                            if (stored) opts = JSON.parse(stored);
                                        } catch (e) {}
                                        if (!Array.isArray(opts) || opts.length === 0) {
                                            opts = (categoriasStateRef && categoriasStateRef.list && categoriasStateRef.list.length) ? categoriasStateRef.list.slice() : [];
                                        } else {
                                            opts = opts.slice();
                                        }
                                        var currentVal = rawVal != null ? String(rawVal).trim() : "";
                                        if (currentVal && opts.indexOf(currentVal) === -1) opts.unshift(currentVal);
                                        opts = opts.filter(function (v) { return v != null && String(v).trim() !== ""; });
                                        if (opts.length === 0) opts = ["Sin categoría"];
                                        var wrapCat = document.createElement("div");
                                        wrapCat.className = "costos-edit-categoria-wrap";
                                        var sel = document.createElement("select");
                                        sel.className = "costos-edit-input-dynamic costos-edit-select-categoria";
                                        opts.forEach(function (v) {
                                            var opt = document.createElement("option");
                                            opt.value = String(v).trim();
                                            opt.textContent = opt.value;
                                            if (opt.value === currentVal) opt.selected = true;
                                            sel.appendChild(opt);
                                        });
                                        var optNueva = document.createElement("option");
                                        optNueva.value = "__nueva__";
                                        optNueva.textContent = "— Agregar otra —";
                                        sel.appendChild(optNueva);
                                        wrapCat.appendChild(sel);
                                        inp = document.createElement("input");
                                        inp.type = "text";
                                        inp.className = "costos-edit-input-dynamic costos-edit-input-otra-categoria";
                                        inp.style.display = "none";
                                        inp.placeholder = "Escribí la nueva categoría";
                                        wrapCat.appendChild(inp);
                                        var hiddenVal = document.createElement("input");
                                        hiddenVal.type = "hidden";
                                        hiddenVal.className = "costos-edit-input";
                                        hiddenVal.setAttribute("data-header-index", String(idx));
                                        hiddenVal.value = currentVal || "";
                                        wrapCat.appendChild(hiddenVal);
                                        function syncHidden() {
                                            hiddenVal.value = sel.value === "__nueva__" ? (inp.value || "").trim() : sel.value;
                                        }
                                        sel.addEventListener("change", function () {
                                            if (sel.value === "__nueva__") {
                                                inp.style.display = "";
                                                inp.value = currentVal && opts.indexOf(currentVal) === -1 ? currentVal : "";
                                                inp.focus();
                                            } else {
                                                inp.style.display = "none";
                                                inp.value = "";
                                            }
                                            syncHidden();
                                        });
                                        inp.addEventListener("input", function () {
                                            if (sel.value === "__nueva__") sel.options[sel.selectedIndex].text = inp.value || "— Agregar otra —";
                                            syncHidden();
                                        });
                                        inp.addEventListener("blur", function () {
                                            if (sel.value === "__nueva__" && inp.value.trim()) optNueva.textContent = inp.value.trim();
                                            syncHidden();
                                        });
                                        cell.insertBefore(wrapCat, span);
                                        inp._costosValueElement = sel;
                                        var elementToRemove = wrapCat;
                                        var elementToFocus = sel;
                                    } else if (isMarcaField && form) {
                                        var optsM = [];
                                        try {
                                            var storedM = sessionStorage.getItem("costosDistinctMarcas");
                                            if (storedM) optsM = JSON.parse(storedM);
                                        } catch (e) {}
                                        if (!Array.isArray(optsM) || optsM.length === 0) optsM = [];
                                        optsM = optsM.slice();
                                        var currentValM = rawVal != null ? String(rawVal).trim() : "";
                                        if (currentValM && optsM.indexOf(currentValM) === -1) optsM.unshift(currentValM);
                                        optsM = optsM.filter(function (v) { return v != null && String(v).trim() !== ""; });
                                        if (optsM.length === 0) optsM = ["—"];
                                        var wrapMarca = document.createElement("div");
                                        wrapMarca.className = "costos-edit-marca-wrap costos-edit-combo-wrap";
                                        var selM = document.createElement("select");
                                        selM.className = "costos-edit-input-dynamic costos-edit-select-marca";
                                        optsM.forEach(function (v) {
                                            var opt = document.createElement("option");
                                            opt.value = String(v).trim();
                                            opt.textContent = opt.value;
                                            if (opt.value === currentValM) opt.selected = true;
                                            selM.appendChild(opt);
                                        });
                                        var optNuevaM = document.createElement("option");
                                        optNuevaM.value = "__nueva__";
                                        optNuevaM.textContent = "— Agregar otra —";
                                        selM.appendChild(optNuevaM);
                                        wrapMarca.appendChild(selM);
                                        inp = document.createElement("input");
                                        inp.type = "text";
                                        inp.className = "costos-edit-input-dynamic costos-edit-input-otra-marca";
                                        inp.style.display = "none";
                                        inp.placeholder = "Escribí la nueva marca";
                                        wrapMarca.appendChild(inp);
                                        var hiddenValM = document.createElement("input");
                                        hiddenValM.type = "hidden";
                                        hiddenValM.className = "costos-edit-input";
                                        hiddenValM.setAttribute("data-header-index", String(idx));
                                        hiddenValM.value = currentValM || "";
                                        wrapMarca.appendChild(hiddenValM);
                                        function syncHiddenM() {
                                            hiddenValM.value = selM.value === "__nueva__" ? (inp.value || "").trim() : selM.value;
                                        }
                                        selM.addEventListener("change", function () {
                                            if (selM.value === "__nueva__") {
                                                inp.style.display = "";
                                                inp.value = currentValM && optsM.indexOf(currentValM) === -1 ? currentValM : "";
                                                inp.focus();
                                            } else { inp.style.display = "none"; inp.value = ""; }
                                            syncHiddenM();
                                        });
                                        inp.addEventListener("input", function () {
                                            if (selM.value === "__nueva__") selM.options[selM.selectedIndex].text = inp.value || "— Agregar otra —";
                                            syncHiddenM();
                                        });
                                        inp.addEventListener("blur", function () {
                                            if (selM.value === "__nueva__" && inp.value.trim()) optNuevaM.textContent = inp.value.trim();
                                            syncHiddenM();
                                        });
                                        cell.insertBefore(wrapMarca, span);
                                        var elementToRemove = wrapMarca;
                                        var elementToFocus = selM;
                                    } else if (isLugarField && form) {
                                        var optsL = [];
                                        try {
                                            var storedL = sessionStorage.getItem("costosDistinctLugares");
                                            if (storedL) optsL = JSON.parse(storedL);
                                        } catch (e) {}
                                        if (!Array.isArray(optsL) || optsL.length === 0) optsL = [];
                                        optsL = optsL.slice();
                                        var currentValL = rawVal != null ? String(rawVal).trim() : "";
                                        if (currentValL && optsL.indexOf(currentValL) === -1) optsL.unshift(currentValL);
                                        optsL = optsL.filter(function (v) { return v != null && String(v).trim() !== ""; });
                                        if (optsL.length === 0) optsL = ["—"];
                                        var wrapLugar = document.createElement("div");
                                        wrapLugar.className = "costos-edit-lugar-wrap costos-edit-combo-wrap";
                                        var selL = document.createElement("select");
                                        selL.className = "costos-edit-input-dynamic costos-edit-select-lugar";
                                        optsL.forEach(function (v) {
                                            var opt = document.createElement("option");
                                            opt.value = String(v).trim();
                                            opt.textContent = opt.value;
                                            if (opt.value === currentValL) opt.selected = true;
                                            selL.appendChild(opt);
                                        });
                                        var optNuevaL = document.createElement("option");
                                        optNuevaL.value = "__nueva__";
                                        optNuevaL.textContent = "— Agregar otra —";
                                        selL.appendChild(optNuevaL);
                                        wrapLugar.appendChild(selL);
                                        inp = document.createElement("input");
                                        inp.type = "text";
                                        inp.className = "costos-edit-input-dynamic costos-edit-input-otra-lugar";
                                        inp.style.display = "none";
                                        inp.placeholder = "Escribí el nuevo lugar";
                                        wrapLugar.appendChild(inp);
                                        var hiddenValL = document.createElement("input");
                                        hiddenValL.type = "hidden";
                                        hiddenValL.className = "costos-edit-input";
                                        hiddenValL.setAttribute("data-header-index", String(idx));
                                        hiddenValL.value = currentValL || "";
                                        wrapLugar.appendChild(hiddenValL);
                                        function syncHiddenL() {
                                            hiddenValL.value = selL.value === "__nueva__" ? (inp.value || "").trim() : selL.value;
                                        }
                                        selL.addEventListener("change", function () {
                                            if (selL.value === "__nueva__") {
                                                inp.style.display = "";
                                                inp.value = currentValL && optsL.indexOf(currentValL) === -1 ? currentValL : "";
                                                inp.focus();
                                            } else { inp.style.display = "none"; inp.value = ""; }
                                            syncHiddenL();
                                        });
                                        inp.addEventListener("input", function () {
                                            if (selL.value === "__nueva__") selL.options[selL.selectedIndex].text = inp.value || "— Agregar otra —";
                                            syncHiddenL();
                                        });
                                        inp.addEventListener("blur", function () {
                                            if (selL.value === "__nueva__" && inp.value.trim()) optNuevaL.textContent = inp.value.trim();
                                            syncHiddenL();
                                        });
                                        cell.insertBefore(wrapLugar, span);
                                        var elementToRemove = wrapLugar;
                                        var elementToFocus = selL;
                                    } else {
                                        inp = document.createElement("input");
                                        inp.type = "text";
                                        inp.className = "costos-edit-input costos-edit-input-dynamic";
                                        inp.setAttribute("data-header-index", String(idx));
                                        inp.value = rawVal != null ? String(rawVal).trim() : "";
                                        cell.insertBefore(inp, span);
                                        var elementToRemove = inp;
                                        var elementToFocus = inp;
                                    }
                                    span.style.display = "none";
                                    editIcon.style.display = "none";
                                    var closeBtn = document.createElement("button");
                                    closeBtn.type = "button";
                                    closeBtn.className = "costos-edit-value-close-btn";
                                    closeBtn.setAttribute("title", "Cerrar sin guardar en este campo");
                                    closeBtn.setAttribute("aria-label", "Cerrar");
                                    closeBtn.innerHTML = "<i class=\"fa-solid fa-xmark\" aria-hidden=\"true\"></i>";
                                    cell.appendChild(closeBtn);
                                    closeBtn.addEventListener("click", function () {
                                        span.style.display = "";
                                        if (elementToRemove.parentNode) elementToRemove.parentNode.removeChild(elementToRemove);
                                        removeDatalistCategoria();
                                        closeBtn.parentNode.removeChild(closeBtn);
                                        editIcon.style.display = "";
                                    });
                                    if (elementToFocus) elementToFocus.focus();
                                });
                            })(wrap, valueCell, valueSpan, i, value, i === categoriaColIdx, i === marcaColIdx, i === lugarColIdx, formEl, categoriasState);
                        }
                        wrap.appendChild(label);
                        wrap.appendChild(valueCell);

                        if (editable) {
                            var input = document.createElement("input");
                            input.type = "text";
                            input.className = "costos-edit-input";
                            input.name = "field_" + i;
                            input.setAttribute("data-header-index", String(i));
                            if (isPrecioEditable(nameNorm)) {
                                input.value = "";
                                input.placeholder = "Ingrese el precio actual";
                                input.setAttribute("required", "required");
                                input.setAttribute("aria-required", "true");
                            } else {
                                input.value = value;
                                input.placeholder = "Ej: 18800,00";
                            }
                            wrap.appendChild(input);
                        } else if (isObservaciones) {
                            var textarea = document.createElement("textarea");
                            textarea.className = "costos-edit-input costos-edit-textarea";
                            textarea.name = "field_" + i;
                            textarea.setAttribute("data-header-index", String(i));
                            textarea.setAttribute("aria-required", "false");
                            textarea.value = value;
                            textarea.placeholder = "Cargar observaciones… (opcional)";
                            textarea.rows = 4;
                            wrap.appendChild(textarea);
                        }

                        fieldsContainer.appendChild(wrap);
                    });

                    (function () {
                        var appsScriptUrl = (typeof APP_CONFIG !== "undefined" && APP_CONFIG.appsScriptUrl) ? APP_CONFIG.appsScriptUrl : "";
                        if (!appsScriptUrl) return;
                        fetch(appsScriptUrl + "?action=list&sheet=materiaPrima&limit=10000", { cache: "no-store" })
                            .then(function (res) { return res.json(); })
                            .then(function (json) {
                                if (!json || !json.success || !json.data) return;
                                var apiHeaders = Array.isArray(json.data.headers) ? json.data.headers : [];
                                var apiRows = Array.isArray(json.data.rows) ? json.data.rows : [];
                                var catKey = null;
                                var catIdxApi = -1;
                                for (var ai = 0; ai < apiHeaders.length; ai++) {
                                    var ah = String(apiHeaders[ai] != null ? apiHeaders[ai] : "").trim();
                                    var ahNorm = normHeaderForCompare(ah);
                                    var ahTrim = ah.toLowerCase().replace(/\s/g, "");
                                    if (ahNorm === "categoria" || ahTrim === "categoria" || ahTrim === "categoría") {
                                        catKey = ah;
                                        catIdxApi = ai;
                                        break;
                                    }
                                }
                                if (!catKey && apiHeaders.length > 1) {
                                    catKey = apiHeaders[1];
                                    catIdxApi = 1;
                                }
                                if (!catKey) return;
                                var seen = {};
                                var allCats = [];
                                apiRows.forEach(function (row) {
                                    var v = "";
                                    if (row[catKey] != null && String(row[catKey]).trim() !== "") {
                                        v = String(row[catKey]).trim();
                                    } else if (catIdxApi >= 0 && Array.isArray(row) && row[catIdxApi] != null) {
                                        v = String(row[catIdxApi]).trim();
                                    }
                                    if (!v) v = "Sin categoría";
                                    if (!seen[v]) { seen[v] = true; allCats.push(v); }
                                });
                                if (allCats.length === 0) return;
                                allCats.sort(function (a, b) {
                                    if (a === "Sin categoría") return 1;
                                    if (b === "Sin categoría") return -1;
                                    return a.localeCompare(b);
                                });
                                categoriasState.list = allCats;
                                try { sessionStorage.setItem("costosDistinctCategorias", JSON.stringify(allCats)); } catch (err) {}
                                var marcaKey = null;
                                var lugarKey = null;
                                for (var ki = 0; ki < apiHeaders.length; ki++) {
                                    var h = String(apiHeaders[ki] != null ? apiHeaders[ki] : "").trim().toLowerCase().replace(/\s/g, "");
                                    if (h === "marca") marcaKey = apiHeaders[ki];
                                    if (h === "lugar") lugarKey = apiHeaders[ki];
                                }
                                if (marcaKey) {
                                    var seenM = {};
                                    var allMarcas = [];
                                    apiRows.forEach(function (row) {
                                        var v = row[marcaKey] != null ? String(row[marcaKey]).trim() : "";
                                        if (!v) v = "—";
                                        if (!seenM[v]) { seenM[v] = true; allMarcas.push(v); }
                                    });
                                    allMarcas.sort(function (a, b) {
                                        if (a === "—") return 1;
                                        if (b === "—") return -1;
                                        return a.localeCompare(b);
                                    });
                                    try { sessionStorage.setItem("costosDistinctMarcas", JSON.stringify(allMarcas)); } catch (err) {}
                                }
                                if (lugarKey) {
                                    var seenL = {};
                                    var allLugares = [];
                                    apiRows.forEach(function (row) {
                                        var v = row[lugarKey] != null ? String(row[lugarKey]).trim() : "";
                                        if (!v) v = "—";
                                        if (!seenL[v]) { seenL[v] = true; allLugares.push(v); }
                                    });
                                    allLugares.sort(function (a, b) {
                                        if (a === "—") return 1;
                                        if (b === "—") return -1;
                                        return a.localeCompare(b);
                                    });
                                    try { sessionStorage.setItem("costosDistinctLugares", JSON.stringify(allLugares)); } catch (err) {}
                                }
                            })
                            .catch(function () {});
                    })();

                    (function () {
                        var precioActualInput = formEl.querySelector(".costos-edit-input[placeholder=\"Ingrese el precio actual\"]");
                        var cantidadField = formEl.querySelector(".costos-edit-field[data-field=\"cantidad-unidad-medida\"]");
                        var precioAnteriorField = formEl.querySelector(".costos-edit-field[data-field=\"precio-anterior\"]");
                        var precioCostoField = formEl.querySelector(".costos-edit-field[data-field=\"precio-costo-x-unidad\"]");
                        var equivalenciaField = formEl.querySelector(".costos-edit-field[data-field=\"equivalencia-unidad-medida\"]");
                        var precioEquivalenciaField = formEl.querySelector(".costos-edit-field[data-field=\"precio-equivalencia-x-unidad\"]");
                        if (!precioActualInput || !cantidadField || !precioCostoField) return;
                        var cantidadSpan = cantidadField.querySelector(".costos-edit-value");
                        var precioAnteriorSpan = precioAnteriorField ? precioAnteriorField.querySelector(".costos-edit-value") : null;
                        var precioCostoSpan = precioCostoField.querySelector(".costos-edit-value");
                        var equivalenciaSpan = equivalenciaField ? equivalenciaField.querySelector(".costos-edit-value") : null;
                        var precioEquivalenciaSpan = precioEquivalenciaField ? precioEquivalenciaField.querySelector(".costos-edit-value") : null;
                        if (!cantidadSpan || !precioCostoSpan) return;
                        function parsePrecioFromDisplay(str) {
                            if (!str || !String(str).trim()) return NaN;
                            var s = String(str).trim().replace(/\$\s?/g, "").replace(/\./g, "").replace(",", ".");
                            return parseFloat(s);
                        }
                        function updatePrecioCosto() {
                            var precioStr = (precioActualInput.value || "").trim();
                            var precio = parseFloat(precioStr.replace(",", "."));
                            if (isNaN(precio) && precioAnteriorSpan) {
                                precio = parsePrecioFromDisplay(precioAnteriorSpan.textContent);
                            }
                            var cantidadStr = (cantidadSpan.textContent || "").replace(/\s/g, "").trim();
                            var cantidad = parseFloat(cantidadStr.replace(/\./g, "").replace(",", "."));
                            if (isNaN(cantidad)) cantidad = parseFloat(cantidadStr.replace(",", "."));
                            if (!isNaN(precio) && !isNaN(cantidad) && cantidad !== 0) {
                                var result = precio / cantidad;
                                precioCostoSpan.textContent = formatMonedaArg(result);
                                if (equivalenciaSpan && precioEquivalenciaSpan) {
                                    var equivStr = (equivalenciaSpan.textContent || "").replace(/\s/g, "").trim();
                                    var equiv = parseFloat(equivStr.replace(",", "."));
                                    if (!isNaN(equiv) && equiv !== 0) {
                                        precioEquivalenciaSpan.textContent = formatMonedaArg(result / equiv);
                                    } else {
                                        precioEquivalenciaSpan.textContent = "—";
                                    }
                                }
                            } else {
                                precioCostoSpan.textContent = "—";
                                if (precioEquivalenciaSpan) precioEquivalenciaSpan.textContent = "—";
                            }
                        }
                        precioActualInput.addEventListener("input", updatePrecioCosto);
                        precioActualInput.addEventListener("change", updatePrecioCosto);
                        updatePrecioCosto();
                    })();

                    (function () {
                        var saveBtn = formEl.querySelector(".costos-edit-btn-save");
                        var precioInput = formEl.querySelector(".costos-edit-input[placeholder=\"Ingrese el precio actual\"]");
                        if (!saveBtn || !precioInput) return;
                        function setSaveButtonState() {
                            saveBtn.disabled = !(precioInput.value || "").trim();
                        }
                        setSaveButtonState();
                        precioInput.addEventListener("input", setSaveButtonState);
                        precioInput.addEventListener("change", setSaveButtonState);
                    })();

                    formEl.addEventListener("submit", function (e) {
                        e.preventDefault();
                        var precioActualInput = formEl.querySelector(".costos-edit-input[placeholder=\"Ingrese el precio actual\"]");
                        if (precioActualInput && !(precioActualInput.value || "").trim()) {
                            alert("El precio actual es obligatorio. Ingresá un valor antes de guardar.");
                            precioActualInput.focus();
                            return;
                        }
                        var inputs = formEl.querySelectorAll(".costos-edit-input");
                        var newRow = row.slice();
                        inputs.forEach(function (input) {
                            var idx = parseInt(input.getAttribute("data-header-index"), 10);
                            if (!isNaN(idx) && idx >= 0 && idx < newRow.length) {
                                newRow[idx] = input.value;
                            }
                        });
                        if (fechaActualizadaIdx >= 0 && fechaActualizadaIdx < newRow.length) {
                            newRow[fechaActualizadaIdx] = getTodayDate();
                        }
                        try {
                            sessionStorage.setItem("costosEditRecord", JSON.stringify({
                                id: data.id,
                                headers: data.headers,
                                row: newRow
                            }));
                        } catch (err) {}
                        var appsScriptUrl = (window.APP_CONFIG && window.APP_CONFIG.appsScriptUrl) ? String(window.APP_CONFIG.appsScriptUrl).trim() : "";
                        if (!appsScriptUrl) {
                            alert("No está configurada la URL de la API (appsScriptUrl en config.js). Los cambios quedaron guardados solo en esta sesión.");
                            return;
                        }
                        var headers = data.headers || [];
                        var body = { action: "update", sheet: "materiaPrima", id: data.id || "" };
                        for (var h = 0; h < headers.length; h++) {
                            var headerName = String(headers[h] != null ? headers[h] : "").trim();
                            if (headerName) body[headerName] = newRow[h] != null ? newRow[h] : "";
                        }
                        var saveBtn = formEl.querySelector(".costos-edit-btn-save");
                        var btnText = saveBtn ? saveBtn.innerHTML : "";
                        if (saveBtn) {
                            saveBtn.disabled = true;
                            saveBtn.innerHTML = "<i class=\"fa-solid fa-spinner fa-spin\" aria-hidden=\"true\"></i> Guardando…";
                        }
                        var formBody = new URLSearchParams();
                        for (var key in body) {
                            if (body.hasOwnProperty(key)) formBody.append(key, body[key] != null ? body[key] : "");
                        }
                        fetch(appsScriptUrl, {
                            method: "POST",
                            body: formBody
                        })
                            .then(function (res) { return res.text(); })
                            .then(function (text) {
                                var json;
                                try {
                                    json = JSON.parse(text);
                                } catch (e) {
                                    if (text && (text.trim().indexOf("<!DOCTYPE") === 0 || text.trim().indexOf("<html") === 0)) {
                                        throw new Error("El servidor respondió con una página HTML en lugar de JSON. Revisá que el proyecto de Apps Script tenga doPost y doGet desplegados como aplicación web (Implementar → Nueva implementación).");
                                    }
                                    throw new Error("Respuesta no válida del servidor: " + (text ? text.substring(0, 80) + "…" : "vacía"));
                                }
                                return json;
                            })
                            .then(function (json) {
                                if (saveBtn) {
                                    saveBtn.disabled = false;
                                    saveBtn.innerHTML = btnText;
                                }
                                if (json && json.success) {
                                    alert("Cambios guardados en la hoja correctamente.");
                                    window.location.href = "materia-prima.html";
                                } else {
                                    alert("Error al guardar en la hoja: " + (json && json.error ? json.error : "Respuesta inválida"));
                                }
                            })
                            .catch(function (err) {
                                if (saveBtn) {
                                    saveBtn.disabled = false;
                                    saveBtn.innerHTML = btnText;
                                }
                                alert("Error de conexión al guardar: " + (err.message || "Revisá appsScriptUrl y que la hoja esté publicada."));
                            });
                    });
                } catch (err) {
                    noDataEl.style.display = "block";
                    formEl.style.display = "none";
                }
            }
        })();
    </script>
</body>
</html>
